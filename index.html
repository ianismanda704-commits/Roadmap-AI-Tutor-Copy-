<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Learning Plan</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
<style>
:root {
  --bg: #0c0c12;
  --sidebar-bg: #111118;
  --surface: #16161f;
  --surface2: #1e1e28;
  --border: #25252f;
  --accent: #7c6af7;
  --accent2: #4ecdaa;
  --accent-glow: rgba(124,106,247,0.2);
  --text: #e4e4f0;
  --muted: #64647a;
  --muted2: #44445a;
  --danger: #f76a6a;
  --gold: #ffc828;
  --gold-bg: rgba(255,200,40,0.08);
  --gold-border: rgba(255,200,40,0.3);
  --sidebar-w: 260px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg); color: var(--text);
  font-family: 'Inter', sans-serif;
  min-height: 100vh; overflow-x: hidden;
}
body::before {
  content: ''; position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(124,106,247,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(124,106,247,0.03) 1px, transparent 1px);
  background-size: 44px 44px;
  pointer-events: none; z-index: 0;
}
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(14px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ WIZARD ‚îÄ‚îÄ */
#wizardPage {
  min-height: 100vh; display: flex;
  flex-direction: column; position: relative; z-index: 1;
}
.wizard-container {
  max-width: 780px; margin: 0 auto;
  padding: 0 24px 80px; width: 100%;
}
header { padding: 44px 0 36px; text-align: center; }
.logo {
  display: inline-flex; align-items: center;
  gap: 10px; margin-bottom: 20px;
}
.logo-icon {
  width: 34px; height: 34px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 8px; display: grid; place-items: center; font-size: 16px;
}
.logo-text {
  font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700;
  letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted);
}
h1 {
  font-family: 'Syne', sans-serif;
  font-size: clamp(1.8rem, 4.5vw, 3rem);
  font-weight: 800; line-height: 1.1;
  background: linear-gradient(135deg, #fff 0%, var(--accent) 55%, var(--accent2) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  margin-bottom: 10px;
}
.subtitle { color: var(--muted); font-family: 'JetBrains Mono', monospace; font-size: 13px; }
.progress-track { display: flex; align-items: center; margin-bottom: 32px; }
.prog-step { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
.prog-bubble {
  width: 30px; height: 30px; border-radius: 50%;
  background: var(--surface2); border: 2px solid var(--border);
  display: grid; place-items: center;
  font-size: 11px; font-weight: 700;
  font-family: 'JetBrains Mono', monospace; color: var(--muted); transition: all 0.3s;
}
.prog-step.active .prog-bubble { background: var(--accent); border-color: var(--accent); color: #fff; box-shadow: 0 0 14px var(--accent-glow); }
.prog-step.done .prog-bubble { background: var(--accent2); border-color: var(--accent2); color: #000; }
.prog-label {
  font-size: 9px; color: var(--muted); font-weight: 600;
  letter-spacing: 0.06em; text-transform: uppercase; text-align: center; max-width: 60px;
}
.prog-step.active .prog-label { color: var(--accent); }
.prog-step.done .prog-label { color: var(--accent2); }
.prog-line { flex: 1; height: 2px; background: var(--border); margin-top: -18px; align-self: flex-start; transition: background 0.3s; }
.prog-line.done { background: var(--accent2); }
.q-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 16px; padding: 32px; animation: fadeUp 0.35s ease;
}
.q-number { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 500; color: var(--accent); text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 8px; }
.q-title { font-family: 'Syne', sans-serif; font-size: 1.35rem; font-weight: 700; margin-bottom: 22px; line-height: 1.3; }
.options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 10px; margin-bottom: 22px; }
.opt-btn {
  background: var(--surface2); border: 1.5px solid var(--border);
  border-radius: 10px; padding: 13px 15px; color: var(--text);
  font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 600;
  cursor: pointer; text-align: left; transition: all 0.2s;
  display: flex; align-items: center; gap: 10px;
}
.opt-btn:hover { border-color: var(--accent); background: rgba(124,106,247,0.08); color: #fff; }
.opt-btn.selected { border-color: var(--accent); background: rgba(124,106,247,0.14); color: #fff; box-shadow: inset 0 0 0 1px var(--accent); }
.opt-icon { font-size: 17px; flex-shrink: 0; }
.q-textarea {
  width: 100%; background: var(--surface2); border: 1.5px solid var(--border);
  border-radius: 10px; padding: 13px 15px; color: var(--text);
  font-family: 'JetBrains Mono', monospace; font-size: 13px;
  resize: vertical; min-height: 95px; outline: none;
  transition: border-color 0.2s; margin-bottom: 22px;
}
.q-textarea:focus { border-color: var(--accent); }
.q-textarea::placeholder { color: var(--muted); }
.q-nav { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
.btn { padding: 11px 22px; border-radius: 8px; font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; border: none; transition: all 0.2s; letter-spacing: 0.02em; }
.btn-ghost { background: transparent; border: 1.5px solid var(--border); color: var(--muted); }
.btn-ghost:hover { border-color: var(--muted); color: var(--text); }
.btn-primary { background: var(--accent); color: #fff; box-shadow: 0 4px 18px rgba(124,106,247,0.3); }
.btn-primary:hover { background: #9180ff; transform: translateY(-1px); }
.btn-primary:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
.btn-generate {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff; font-size: 14px; padding: 13px 30px;
  box-shadow: 0 4px 24px rgba(124,106,247,0.35); width: 100%; margin-top: 4px;
}
.btn-generate:hover { transform: translateY(-2px); box-shadow: 0 6px 32px rgba(124,106,247,0.5); }

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#loadingPage {
  display: none; min-height: 100vh;
  place-items: center; text-align: center;
  padding: 20px; position: relative; z-index: 1;
}
.loader-ring {
  width: 56px; height: 56px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-right-color: var(--accent2);
  border-radius: 50%; animation: spin 0.75s linear infinite;
  margin: 0 auto 20px;
}
.loading-title { font-family: 'Syne', sans-serif; font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; }
.loading-sub { color: var(--muted); font-family: 'JetBrains Mono', monospace; font-size: 12px; }
.loading-dots::after { content: ''; animation: dots 1.4s infinite; }
@keyframes dots { 0%{content:''} 33%{content:'.'} 66%{content:'..'} 100%{content:'...'} }

/* ‚îÄ‚îÄ APP LAYOUT ‚îÄ‚îÄ */
#appPage { display: none; min-height: 100vh; }
.app-layout { display: flex; min-height: 100vh; }

/* Sidebar */
.app-sidebar {
  width: var(--sidebar-w); background: var(--sidebar-bg);
  border-right: 1px solid var(--border);
  position: fixed; top: 0; left: 0; height: 100vh;
  overflow-y: auto; z-index: 50; display: flex; flex-direction: column;
}
.app-sidebar::-webkit-scrollbar { width: 4px; }
.app-sidebar::-webkit-scrollbar-thumb { background: var(--muted2); border-radius: 2px; }
.sidebar-brand { padding: 20px 20px 16px; border-bottom: 1px solid var(--border); }
.brand-logo {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 8px; display: grid; place-items: center;
  font-size: 16px; margin-bottom: 10px;
}
.brand-name { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
.brand-sub { font-size: 11px; color: var(--muted); margin-top: 2px; line-height: 1.4; }
.sidebar-section { padding: 14px 12px 6px; }
.sidebar-section-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); padding: 0 8px; margin-bottom: 6px; }
.sidebar-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 10px; border-radius: 8px;
  font-size: 13px; font-weight: 500; color: var(--muted);
  cursor: pointer; transition: all 0.15s;
}
.sidebar-item:hover { background: var(--surface2); color: var(--text); }
.sidebar-item.active { background: rgba(124,106,247,0.12); color: var(--accent); }
.sidebar-item .item-icon { font-size: 14px; width: 18px; text-align: center; }
.sidebar-divider { height: 1px; background: var(--border); margin: 8px 12px; }

/* Plan step nav */
.plan-step-list { padding: 6px 12px; }
.step-nav-item {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 8px 8px; border-radius: 8px;
  cursor: pointer; transition: background 0.15s; margin-bottom: 2px;
}
.step-nav-item:hover { background: var(--surface2); }
.step-nav-item.active { background: rgba(124,106,247,0.1); }
.step-nav-num {
  width: 20px; height: 20px; border-radius: 5px;
  background: var(--surface2); border: 1px solid var(--border);
  display: grid; place-items: center;
  font-size: 9px; font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted); flex-shrink: 0; margin-top: 1px;
}
.step-nav-item.active .step-nav-num { background: var(--accent); border-color: var(--accent); color: #fff; }
.step-nav-title { font-size: 12px; font-weight: 600; color: var(--text); line-height: 1.35; }
.step-nav-count { font-size: 10px; color: var(--muted); margin-top: 1px; }

/* Lesson outline sidebar */
.outline-step-header { display: flex; align-items: center; gap: 8px; padding: 10px 16px 6px; }
.outline-step-badge { font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace; background: var(--surface2); color: var(--muted); padding: 2px 6px; border-radius: 4px; white-space: nowrap; }
.outline-step-name { font-size: 12px; font-weight: 600; color: var(--muted); }
.outline-course-item {
  display: flex; align-items: center; gap: 10px;
  padding: 7px 16px 7px 28px;
  font-size: 12px; font-weight: 500; color: var(--muted);
  cursor: pointer; transition: all 0.15s; line-height: 1.35;
}
.outline-course-item:hover { background: var(--surface2); color: var(--text); }
.outline-course-item.active { background: rgba(124,106,247,0.1); color: var(--accent); border-right: 2px solid var(--accent); }
.outline-num {
  width: 18px; height: 18px; border-radius: 50%;
  background: var(--surface2); border: 1px solid var(--border);
  display: grid; place-items: center;
  font-size: 9px; font-weight: 700; flex-shrink: 0;
  font-family: 'JetBrains Mono', monospace;
}
.outline-course-item.active .outline-num { background: var(--accent); border-color: var(--accent); color: #fff; }

/* Main */
.app-main { margin-left: var(--sidebar-w); flex: 1; min-width: 0; }

/* Plan View */
#planView { padding: 40px 48px 80px; max-width: 900px; }
.plan-breadcrumb { font-size: 12px; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-bottom: 16px; }
.plan-title { font-family: 'Syne', sans-serif; font-size: clamp(1.6rem, 3vw, 2.4rem); font-weight: 800; margin-bottom: 8px; line-height: 1.15; }
.plan-meta { font-size: 13px; color: var(--muted); margin-bottom: 28px; }
.plan-actions { display: flex; gap: 10px; margin-bottom: 40px; flex-wrap: wrap; }
.action-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: 8px;
  font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 600;
  cursor: pointer; transition: all 0.2s; border: none;
}
.action-btn-ghost { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
.action-btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.action-btn-danger { background: var(--surface); border: 1px solid var(--border); color: var(--muted); }
.action-btn-danger:hover { border-color: var(--danger); color: var(--danger); }
.step-block { margin-bottom: 36px; animation: fadeUp 0.4s ease; }
.step-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
.step-badge-row { display: flex; align-items: center; gap: 12px; }
.step-badge { display: inline-flex; align-items: center; gap: 6px; background: var(--accent); color: #fff; font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700; padding: 5px 10px; border-radius: 6px; }
.step-title-text { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700; }
.step-course-count { font-size: 12px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
.course-list { display: flex; flex-direction: column; gap: 6px; }
.course-row {
  display: flex; align-items: center; gap: 14px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 14px 18px;
  cursor: pointer; transition: all 0.2s;
}
.course-row:hover { border-color: var(--accent); background: rgba(124,106,247,0.05); transform: translateX(3px); }
.course-num {
  width: 26px; height: 26px; border-radius: 7px;
  background: var(--surface2); border: 1px solid var(--border);
  display: grid; place-items: center;
  font-size: 11px; font-weight: 700;
  font-family: 'JetBrains Mono', monospace; color: var(--muted); flex-shrink: 0;
}
.course-name { flex: 1; font-size: 14px; font-weight: 500; color: var(--text); line-height: 1.35; }
.course-arrow { color: var(--muted); font-size: 14px; flex-shrink: 0; transition: transform 0.2s; }
.course-row:hover .course-arrow { transform: translate(2px, -2px); color: var(--accent); }

/* Lesson View */
#lessonView { display: none; }
.lesson-layout { display: flex; min-height: 100vh; }
.lesson-main { flex: 1; min-width: 0; padding: 32px 40px 80px; max-width: 680px; }
.back-btn {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 13px; font-weight: 600; color: var(--muted);
  cursor: pointer; margin-bottom: 24px; transition: color 0.15s;
  background: none; border: none; font-family: 'Inter', sans-serif; padding: 0;
}
.back-btn:hover { color: var(--text); }
.lesson-title { font-family: 'Syne', sans-serif; font-size: 1.6rem; font-weight: 800; line-height: 1.2; margin-bottom: 6px; }
.lesson-meta { font-size: 12px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
.lesson-progress-bar { height: 3px; background: var(--border); border-radius: 2px; margin: 14px 0 28px; overflow: hidden; }
.lesson-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 2px; transition: width 0.5s; }
.lesson-content { line-height: 1.75; font-size: 15px; color: var(--text); }
.lesson-content h2 { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 700; margin: 32px 0 12px; color: #fff; }
.lesson-content h3 { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700; margin: 22px 0 8px; color: var(--text); }
.lesson-content p { margin-bottom: 16px; color: #c4c4d8; }
.lesson-content ul, .lesson-content ol { margin: 0 0 16px 20px; }
.lesson-content li { margin-bottom: 6px; color: #c4c4d8; }
.lesson-content code { background: var(--surface2); border: 1px solid var(--border); padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent2); }
.lesson-content pre { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 18px; overflow-x: auto; margin-bottom: 16px; }
.lesson-content pre code { background: none; border: none; padding: 0; font-size: 13px; color: var(--text); }
.lesson-content strong { color: #fff; font-weight: 600; }
.lesson-loading { display: flex; align-items: center; gap: 12px; padding: 24px 0; color: var(--muted); font-family: 'JetBrains Mono', monospace; font-size: 13px; }
.lesson-spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; flex-shrink: 0; }

/* AI Instructor */
.ai-instructor {
  width: 300px; flex-shrink: 0;
  background: var(--sidebar-bg); border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  height: 100vh; position: sticky; top: 0; overflow: hidden;
}
.instructor-header { padding: 16px 16px 12px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
.instructor-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); box-shadow: 0 0 6px var(--accent2); flex-shrink: 0; }
.instructor-title-text { font-size: 13px; font-weight: 700; }
.instructor-messages { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
.instructor-messages::-webkit-scrollbar { width: 4px; }
.instructor-messages::-webkit-scrollbar-thumb { background: var(--muted2); border-radius: 2px; }
.msg { display: flex; gap: 8px; align-items: flex-start; animation: fadeUp 0.25s ease; }
.msg-avatar { width: 26px; height: 26px; border-radius: 7px; display: grid; place-items: center; font-size: 12px; flex-shrink: 0; }
.msg-ai .msg-avatar { background: linear-gradient(135deg, var(--accent), var(--accent2)); }
.msg-user .msg-avatar { background: var(--surface2); border: 1px solid var(--border); }
.msg-bubble { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 9px 12px; font-size: 12px; line-height: 1.55; color: var(--text); max-width: 220px; }
.msg-ai .msg-bubble { border-radius: 4px 10px 10px 10px; }
.msg-user { flex-direction: row-reverse; }
.msg-user .msg-bubble { background: rgba(124,106,247,0.12); border-color: rgba(124,106,247,0.3); border-radius: 10px 4px 10px 10px; }
.suggested-qs { padding: 0 14px 10px; display: flex; flex-direction: column; gap: 5px; }
.suggested-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 3px; }
.sugg-q { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 7px 10px; font-size: 11px; color: var(--muted); cursor: pointer; transition: all 0.15s; text-align: left; width: 100%; font-family: 'Inter', sans-serif; line-height: 1.4; }
.sugg-q:hover { border-color: var(--accent); color: var(--text); background: rgba(124,106,247,0.06); }
.sugg-q:disabled { opacity: 0.4; cursor: not-allowed; }
.instructor-input-area { padding: 10px 14px; border-top: 1px solid var(--border); display: flex; gap: 8px; align-items: flex-end; }
.instructor-input { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px 11px; color: var(--text); font-family: 'Inter', sans-serif; font-size: 12px; outline: none; transition: border-color 0.2s; resize: none; min-height: 36px; max-height: 90px; }
.instructor-input:focus { border-color: var(--accent); }
.instructor-input::placeholder { color: var(--muted); }
.send-btn { width: 32px; height: 32px; background: var(--accent); border: none; border-radius: 7px; cursor: pointer; display: grid; place-items: center; transition: all 0.2s; color: #fff; font-size: 13px; flex-shrink: 0; }
.send-btn:hover { background: #9180ff; }
.send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.typing-indicator .msg-bubble { display: flex; gap: 4px; align-items: center; padding: 12px; }
.typing-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--muted); animation: typingBounce 1.2s infinite; }
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }

/* Modal */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); z-index: 200; display: none; place-items: center; padding: 20px; }
.modal-overlay.open { display: grid; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 32px; max-width: 480px; width: 100%; animation: fadeUp 0.3s ease; }
.modal h3 { font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; }
.modal p { color: var(--muted); font-size: 13px; margin-bottom: 18px; }
.modal-actions { display: flex; gap: 10px; }

/* ‚îÄ‚îÄ MODE TABS ‚îÄ‚îÄ */
.mode-tabs {
  display: flex; gap: 6px; justify-content: center;
  margin-bottom: 32px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 5px;
}
.mode-tab {
  flex: 1; padding: 10px 16px; border-radius: 8px;
  font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700;
  cursor: pointer; border: none; transition: all 0.2s;
  color: var(--muted); background: transparent;
  display: flex; align-items: center; justify-content: center; gap: 7px;
}
.mode-tab.active { background: var(--accent); color: #fff; box-shadow: 0 2px 12px rgba(124,106,247,0.35); }
.mode-tab:not(.active):hover { color: var(--text); background: var(--surface2); }

/* ‚îÄ‚îÄ COURSE CREATOR ‚îÄ‚îÄ */
#courseCreatorWizard { display: none; animation: fadeUp 0.35s ease; }

.course-creator-label {
  font-size: 13px; font-weight: 600; color: var(--muted);
  margin-bottom: 10px; letter-spacing: 0.02em;
}
.course-topic-input {
  width: 100%; background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 12px; padding: 16px 18px;
  color: var(--text); font-family: 'Inter', sans-serif;
  font-size: 15px; outline: none;
  transition: border-color 0.2s; margin-bottom: 24px;
}
.course-topic-input:focus { border-color: var(--accent); }
.course-topic-input::placeholder { color: var(--muted); }

.format-cards {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 12px; margin-bottom: 20px;
}
.format-card {
  background: var(--surface2); border: 1.5px solid var(--border);
  border-radius: 12px; padding: 20px 16px;
  display: flex; flex-direction: column; align-items: center;
  gap: 10px; cursor: pointer; transition: all 0.2s;
  position: relative;
}
.format-card.active {
  background: rgba(124,106,247,0.1);
  border-color: var(--accent);
  box-shadow: inset 0 0 0 1px var(--accent);
}
.format-card.disabled {
  opacity: 0.38; cursor: not-allowed;
  pointer-events: none;
}
.format-card .fc-icon { font-size: 26px; }
.format-card .fc-label {
  font-family: 'Syne', sans-serif;
  font-size: 14px; font-weight: 700;
  color: var(--muted);
}
.format-card.active .fc-label { color: var(--text); }

.context-checkbox-row {
  display: flex; align-items: center; gap: 10px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 13px 16px;
  margin-bottom: 14px; cursor: pointer;
  transition: border-color 0.2s;
}
.context-checkbox-row:hover { border-color: var(--accent); }
.context-checkbox-row input[type="checkbox"] {
  width: 16px; height: 16px; accent-color: var(--accent);
  cursor: pointer; flex-shrink: 0;
}
.context-checkbox-row label {
  font-size: 14px; font-weight: 500; cursor: pointer; user-select: none;
}

#courseContextArea { display: none; margin-bottom: 6px; }
.context-textarea {
  width: 100%; background: var(--surface2);
  border: 1.5px solid var(--border);
  border-radius: 10px; padding: 13px 15px;
  color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 13px; resize: vertical; min-height: 100px;
  outline: none; transition: border-color 0.2s;
}
.context-textarea:focus { border-color: var(--accent); }
.context-textarea::placeholder { color: var(--muted); }

.btn-course-generate {
  width: 100%; padding: 15px;
  background: #111118; border: 1px solid var(--border);
  border-radius: 12px; color: var(--text);
  font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center;
  gap: 10px; margin-top: 16px;
}
.btn-course-generate:hover {
  background: var(--accent); border-color: var(--accent);
  box-shadow: 0 4px 24px rgba(124,106,247,0.4);
  transform: translateY(-1px);
}
.btn-course-generate:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* Course creator inside app */
#courseCreatorApp {
  display: none; padding: 40px 48px 80px; max-width: 760px;
  animation: fadeUp 0.35s ease;
}
.cca-label {
  font-size: 13px; font-weight: 600; color: var(--muted);
  margin-bottom: 10px;
}
.cca-topic-input {
  width: 100%; background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 12px; padding: 16px 18px;
  color: var(--text); font-family: 'Inter', sans-serif;
  font-size: 15px; outline: none;
  transition: border-color 0.2s; margin-bottom: 28px;
}
.cca-topic-input:focus { border-color: var(--accent); }
.cca-topic-input::placeholder { color: var(--muted); }

/* ‚îÄ‚îÄ GUIDE CREATOR ‚îÄ‚îÄ */
#guideCreatorWizard { display: none; animation: fadeUp 0.35s ease; }

.personalization-group { margin-bottom: 22px; }
.personalization-group .course-creator-label { margin-bottom: 10px; }
.chip-row { display: flex; flex-wrap: wrap; gap: 8px; }
.chip {
  padding: 7px 14px; border-radius: 100px;
  background: var(--surface2); border: 1.5px solid var(--border);
  color: var(--muted); font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.18s;
  font-family: 'Inter', sans-serif;
}
.chip:hover { border-color: var(--accent); color: var(--text); }
.chip.selected { background: rgba(124,106,247,0.15); border-color: var(--accent); color: #fff; box-shadow: inset 0 0 0 1px var(--accent); }
.chip-custom {
  padding: 6px 14px; border-radius: 100px;
  background: transparent; border: 1.5px dashed var(--muted2);
  color: var(--muted); font-size: 13px;
  font-family: 'Inter', sans-serif;
  outline: none; transition: all 0.18s;
  width: 130px; cursor: text;
}
.chip-custom:focus { border-color: var(--accent); color: var(--text); }
.chip-custom::placeholder { color: var(--muted2); }

.skip-link {
  font-size: 12px; color: var(--muted); cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
  background: none; border: none; text-decoration: underline;
  text-underline-offset: 3px; padding: 0;
}
.skip-link:hover { color: var(--text); }

/* ‚îÄ‚îÄ GUIDE VIEW ‚îÄ‚îÄ */
#guideView { display: none; }
.guide-layout {
  display: flex; min-height: 100vh;
}
.guide-main {
  flex: 1; min-width: 0;
  padding: 36px 44px 80px;
  max-width: 720px; overflow-y: auto;
}
.guide-header { margin-bottom: 32px; }
.guide-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--accent); margin-bottom: 8px;
}
.guide-title {
  font-family: 'Syne', sans-serif;
  font-size: clamp(1.5rem, 3vw, 2.1rem);
  font-weight: 800; line-height: 1.15; margin-bottom: 8px;
}
.guide-prefs {
  display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;
}
.guide-pref-tag {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 100px; padding: 4px 10px;
  font-size: 11px; color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
}
.guide-divider { height: 1px; background: var(--border); margin: 28px 0; }
.guide-section-block { margin-bottom: 36px; scroll-margin-top: 20px; }
.guide-section-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 6px; padding: 4px 10px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--muted); margin-bottom: 12px;
}
.guide-section-title {
  font-family: 'Syne', sans-serif;
  font-size: 1.15rem; font-weight: 700;
  margin-bottom: 14px; color: #fff;
}
.guide-content { line-height: 1.75; font-size: 15px; }
.guide-content p { margin-bottom: 14px; color: #c4c4d8; }
.guide-content h3 { font-family: 'Syne', sans-serif; font-size: 0.95rem; font-weight: 700; margin: 18px 0 8px; color: var(--text); }
.guide-content ul, .guide-content ol { margin: 0 0 14px 20px; }
.guide-content li { margin-bottom: 5px; color: #c4c4d8; }
.guide-content code { background: var(--surface2); border: 1px solid var(--border); padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent2); }
.guide-content pre { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; overflow-x: auto; margin-bottom: 14px; }
.guide-content pre code { background: none; border: none; padding: 0; font-size: 12px; color: var(--text); }
.guide-content strong { color: #fff; font-weight: 600; }

/* Section loading */
.section-loading {
  display: flex; align-items: center; gap: 10px;
  color: var(--muted); font-family: 'JetBrains Mono', monospace;
  font-size: 12px; padding: 12px 0;
}
.section-spinner {
  width: 14px; height: 14px; border: 2px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.6s linear infinite; flex-shrink: 0;
}

/* Feedback row */
.guide-feedback {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 18px 22px;
  margin-top: 36px;
  display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
}
.guide-feedback-q { font-size: 14px; font-weight: 600; color: var(--text); }
.feedback-btn {
  padding: 6px 16px; border-radius: 100px;
  border: 1.5px solid var(--border);
  background: transparent; color: var(--muted);
  font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.feedback-btn:hover { border-color: var(--accent2); color: var(--accent2); }
.feedback-btn.yes:hover { border-color: var(--accent2); color: var(--accent2); }
.feedback-btn.no:hover { border-color: var(--danger); color: var(--danger); }

/* Related topics */
.related-topics { margin-top: 28px; }
.related-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 12px; font-family: 'JetBrains Mono', monospace; }
.related-list { display: flex; flex-wrap: wrap; gap: 8px; }
.related-tag {
  padding: 6px 14px; border-radius: 8px;
  background: var(--surface2); border: 1px solid var(--border);
  font-size: 13px; color: var(--text); cursor: pointer;
  transition: all 0.15px; font-weight: 500;
}
.related-tag:hover { border-color: var(--accent); color: var(--accent); background: rgba(124,106,247,0.08); }

/* Guide sidebar section nav */
.guide-section-nav { padding: 6px 12px; }
.guide-nav-item {
  display: flex; align-items: center; gap: 8px;
  padding: 7px 8px; border-radius: 8px;
  cursor: pointer; transition: all 0.15s;
  margin-bottom: 2px;
}
.guide-nav-item:hover { background: var(--surface2); }
.guide-nav-item.active { background: rgba(124,106,247,0.1); }
.guide-nav-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--muted2); flex-shrink: 0; transition: background 0.2s;
}
.guide-nav-item.active .guide-nav-dot { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
.guide-nav-label { font-size: 12px; font-weight: 600; color: var(--muted); line-height: 1.3; }
.guide-nav-item.active .guide-nav-label { color: var(--text); }

/* Guide creator app (inside app, re-uses same layout) */
#guideCreatorApp {
  display: none; padding: 40px 48px 80px; max-width: 760px;
  animation: fadeUp 0.35s ease;
}

/* ‚îÄ‚îÄ QUIZ CREATOR ‚îÄ‚îÄ */
#quizCreatorWizard { display: none; animation: fadeUp 0.35s ease; }
#quizCreatorApp {
  display: none; padding: 40px 48px 80px; max-width: 760px;
  animation: fadeUp 0.35s ease;
}

/* ‚îÄ‚îÄ QUIZ VIEW ‚îÄ‚îÄ */
#quizView { display: none; }
.quiz-layout { display: flex; min-height: 100vh; }
.quiz-main {
  flex: 1; min-width: 0;
  padding: 36px 44px 80px;
  max-width: 760px;
}
.quiz-header { margin-bottom: 32px; }
.quiz-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.12em;
  color: var(--accent2); margin-bottom: 8px;
}
.quiz-title {
  font-family: 'Syne', sans-serif;
  font-size: clamp(1.4rem, 2.5vw, 2rem);
  font-weight: 800; line-height: 1.15; margin-bottom: 8px;
}
.quiz-progress-row {
  display: flex; align-items: center; gap: 14px;
  margin-bottom: 28px;
}
.quiz-progress-bar-wrap {
  flex: 1; height: 4px;
  background: var(--border); border-radius: 2px; overflow: hidden;
}
.quiz-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 2px; transition: width 0.4s;
}
.quiz-progress-label {
  font-size: 11px; font-weight: 700;
  font-family: 'JetBrains Mono', monospace; color: var(--muted);
  white-space: nowrap;
}

/* Question card */
.quiz-q-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 16px; padding: 30px; margin-bottom: 20px;
  animation: fadeUp 0.3s ease;
}
.quiz-q-num {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  font-weight: 600; color: var(--accent); text-transform: uppercase;
  letter-spacing: 0.12em; margin-bottom: 10px;
}
.quiz-q-text {
  font-family: 'Syne', sans-serif; font-size: 1.1rem;
  font-weight: 700; line-height: 1.4; margin-bottom: 22px; color: #fff;
}
.quiz-options { display: flex; flex-direction: column; gap: 9px; }
.quiz-option {
  display: flex; align-items: center; gap: 14px;
  background: var(--surface2); border: 1.5px solid var(--border);
  border-radius: 10px; padding: 13px 16px;
  cursor: pointer; transition: all 0.18s; font-size: 14px; font-weight: 500;
  color: var(--text); user-select: none;
}
.quiz-option:hover:not(.locked) {
  border-color: var(--accent); background: rgba(124,106,247,0.07);
  color: #fff;
}
.quiz-option.selected {
  border-color: var(--accent);
  background: rgba(124,106,247,0.12); color: #fff;
}
.quiz-option.correct {
  border-color: var(--accent2) !important;
  background: rgba(78,205,170,0.12) !important; color: #fff !important;
}
.quiz-option.wrong {
  border-color: var(--danger) !important;
  background: rgba(247,106,106,0.1) !important; color: #c4c4d8 !important;
}
.quiz-option.reveal-correct {
  border-color: var(--accent2) !important;
  background: rgba(78,205,170,0.08) !important;
}
.quiz-option-letter {
  width: 26px; height: 26px; border-radius: 7px;
  background: var(--muted2); border: 1px solid var(--border);
  display: grid; place-items: center;
  font-size: 11px; font-weight: 700; flex-shrink: 0;
  font-family: 'JetBrains Mono', monospace; color: var(--muted);
  transition: all 0.18s;
}
.quiz-option.selected .quiz-option-letter { background: var(--accent); border-color: var(--accent); color: #fff; }
.quiz-option.correct .quiz-option-letter { background: var(--accent2); border-color: var(--accent2); color: #000; }
.quiz-option.wrong .quiz-option-letter { background: var(--danger); border-color: var(--danger); color: #fff; }
.quiz-option.reveal-correct .quiz-option-letter { background: rgba(78,205,170,0.3); border-color: var(--accent2); color: var(--accent2); }
.quiz-option-text { flex: 1; line-height: 1.4; }

/* Feedback bar under question */
.quiz-feedback-bar {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px 16px;
  font-size: 13px; line-height: 1.55; color: #c4c4d8;
  margin-bottom: 16px; display: none; animation: fadeUp 0.2s ease;
}
.quiz-feedback-bar.correct { border-color: rgba(78,205,170,0.4); background: rgba(78,205,170,0.05); }
.quiz-feedback-bar.wrong { border-color: rgba(247,106,106,0.35); background: rgba(247,106,106,0.04); }
.quiz-feedback-label { font-weight: 700; font-family: 'Syne', sans-serif; font-size: 14px; margin-bottom: 4px; }
.quiz-feedback-bar.correct .quiz-feedback-label { color: var(--accent2); }
.quiz-feedback-bar.wrong .quiz-feedback-label { color: var(--danger); }

/* Nav buttons */
.quiz-nav { display: flex; justify-content: flex-end; gap: 10px; }
.quiz-nav-btn {
  padding: 10px 24px; border-radius: 8px;
  font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
  cursor: pointer; border: none; transition: all 0.2s;
}
.quiz-nav-btn-ghost { background: var(--surface); border: 1px solid var(--border); color: var(--muted); }
.quiz-nav-btn-ghost:hover { border-color: var(--accent); color: var(--text); }
.quiz-nav-btn-primary { background: var(--accent); color: #fff; box-shadow: 0 3px 14px rgba(124,106,247,0.3); }
.quiz-nav-btn-primary:hover { background: #9180ff; transform: translateY(-1px); }
.quiz-nav-btn-primary:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }

/* Results */
.quiz-results {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; padding: 40px; text-align: center;
  animation: fadeUp 0.4s ease;
}
.quiz-score-ring {
  width: 110px; height: 110px;
  border-radius: 50%; margin: 0 auto 20px;
  display: grid; place-items: center;
  font-family: 'Syne', sans-serif; font-size: 2rem; font-weight: 800;
  position: relative;
}
.quiz-score-ring::before {
  content: ''; position: absolute; inset: 0;
  border-radius: 50%;
  border: 4px solid var(--border);
}
.quiz-score-ring.great { color: var(--accent2); background: rgba(78,205,170,0.07); }
.quiz-score-ring.great::before { border-color: var(--accent2); box-shadow: 0 0 20px rgba(78,205,170,0.2); }
.quiz-score-ring.ok { color: var(--gold); background: var(--gold-bg); }
.quiz-score-ring.ok::before { border-color: var(--gold); box-shadow: 0 0 20px rgba(255,200,40,0.15); }
.quiz-score-ring.low { color: var(--danger); background: rgba(247,106,106,0.06); }
.quiz-score-ring.low::before { border-color: var(--danger); }
.quiz-results-title { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 800; margin-bottom: 6px; }
.quiz-results-sub { font-size: 13px; color: var(--muted); margin-bottom: 28px; }
.quiz-stat-row {
  display: flex; justify-content: center; gap: 20px; margin-bottom: 32px; flex-wrap: wrap;
}
.quiz-stat {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 14px 20px; min-width: 90px;
}
.quiz-stat-val { font-family: 'Syne', sans-serif; font-size: 1.3rem; font-weight: 800; margin-bottom: 2px; }
.quiz-stat-val.correct { color: var(--accent2); }
.quiz-stat-val.wrong { color: var(--danger); }
.quiz-stat-val.score { color: var(--accent); }
.quiz-stat-lbl { font-size: 11px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
.quiz-result-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
.quiz-review-list { margin-top: 32px; text-align: left; }
.quiz-review-label {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--muted);
  font-family: 'JetBrains Mono', monospace; margin-bottom: 14px;
}
.quiz-review-item {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 14px 16px; margin-bottom: 8px;
  font-size: 13px; line-height: 1.5;
}
.quiz-review-item.ri-correct { border-color: rgba(78,205,170,0.25); }
.quiz-review-item.ri-wrong { border-color: rgba(247,106,106,0.25); }
.quiz-review-q { font-weight: 600; color: var(--text); margin-bottom: 4px; }
.quiz-review-ans { font-size: 12px; }
.ri-correct .quiz-review-ans { color: var(--accent2); }
.ri-wrong .quiz-review-ans { color: var(--danger); }
.quiz-review-correct { font-size: 12px; color: var(--muted); margin-top: 2px; }

/* ‚îÄ‚îÄ ROADMAP CREATOR (wizard) ‚îÄ‚îÄ */
#roadmapCreatorWizard { display: none; animation: fadeUp 0.35s ease; }

/* ‚îÄ‚îÄ ROADMAP CREATOR (app) ‚îÄ‚îÄ */
#roadmapCreatorApp {
  display: none; padding: 40px 48px 80px; max-width: 760px;
  animation: fadeUp 0.35s ease;
}

/* ‚îÄ‚îÄ ROADMAP VIEW ‚îÄ‚îÄ */
#roadmapView { display: none; }
.roadmap-layout { display: flex; min-height: 100vh; }
.roadmap-scroll-area {
  flex: 1; min-width: 0; overflow-y: auto; overflow-x: hidden;
  padding: 32px 32px 80px;
}
.roadmap-header { margin-bottom: 28px; }
.roadmap-header .guide-label { color: var(--gold); }
.roadmap-header .guide-title { 
  font-family: 'Syne', sans-serif;
  font-size: clamp(1.4rem, 2.5vw, 2rem);
  font-weight: 800; margin-bottom: 8px;
}

/* Canvas */
.roadmap-canvas-wrapper { position: relative; }
.roadmap-canvas {
  position: relative;
  min-height: 200px;
}
.rm-connections {
  position: absolute; top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none; z-index: 0;
  overflow: visible;
}

/* Section */
.rm-section {
  margin-bottom: 36px;
  position: relative; z-index: 1;
  animation: fadeUp 0.4s ease;
}
.rm-category-label {
  text-align: center;
  font-size: 11px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 12px;
}

/* 3-column grid */
.rm-grid {
  display: grid;
  grid-template-columns: 1fr 220px 1fr;
  gap: 0 16px;
  align-items: center;
}
.rm-left-col {
  display: flex; flex-direction: column; gap: 6px;
  align-items: flex-end;
}
.rm-right-col {
  display: flex; flex-direction: column; gap: 6px;
  align-items: flex-start;
}

/* Nodes */
.rm-node {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 7px 13px;
  font-size: 12px; font-weight: 500;
  cursor: pointer;
  transition: all 0.18s;
  white-space: nowrap;
  max-width: 210px;
  text-overflow: ellipsis;
  overflow: hidden;
  text-align: center;
  color: var(--text);
  position: relative; z-index: 2;
  user-select: none;
}
.rm-node:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: rgba(124,106,247,0.07);
  transform: scale(1.03);
  box-shadow: 0 0 10px rgba(124,106,247,0.15);
}
.rm-node.rm-selected {
  border-color: var(--accent);
  background: rgba(124,106,247,0.15);
  color: #fff;
  box-shadow: 0 0 14px rgba(124,106,247,0.25);
}

/* Center/main node */
.rm-center-node {
  background: var(--gold-bg);
  border: 2px solid var(--gold-border);
  border-radius: 10px;
  padding: 11px 18px;
  font-size: 13px; font-weight: 700;
  cursor: pointer;
  text-align: center;
  transition: all 0.18s;
  color: var(--gold);
  position: relative; z-index: 2;
  user-select: none;
  line-height: 1.3;
}
.rm-center-node:hover {
  background: rgba(255, 200, 40, 0.14);
  border-color: rgba(255, 200, 40, 0.55);
  box-shadow: 0 0 18px rgba(255, 200, 40, 0.2);
  transform: scale(1.02);
}
.rm-center-node.rm-selected {
  background: rgba(255, 200, 40, 0.18);
  border-color: var(--gold);
  box-shadow: 0 0 22px rgba(255, 200, 40, 0.3);
}

.rm-section-sep {
  height: 1px;
  background: var(--border);
  margin: 18px 0;
  opacity: 0.35;
}

/* Roadmap AI panel */
.rm-ai-panel {
  width: 300px; flex-shrink: 0;
  background: var(--sidebar-bg);
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  height: 100vh; position: sticky; top: 0;
  overflow: hidden;
}
.rm-empty-state {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 24px; text-align: center; gap: 14px;
}
.rm-empty-icon { font-size: 36px; opacity: 0.4; }
.rm-empty-text {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px; color: var(--muted);
  line-height: 1.6;
}
</style>
</head>
<body>

<!-- REVISE MODAL -->
<div class="modal-overlay" id="reviseModal">
  <div class="modal">
    <h3>‚úèÔ∏è Revise Plan</h3>
    <p>Tell the AI what you'd like changed:</p>
    <textarea class="q-textarea" id="reviseInput" placeholder="e.g., Focus more on backend, add more practical projects, skip heavy theory..." style="min-height:110px"></textarea>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeRevise()">Cancel</button>
      <button class="btn btn-primary" onclick="applyRevise()">Apply</button>
    </div>
  </div>
</div>

<!-- WIZARD -->
<div id="wizardPage">
  <div class="wizard-container">
    <header>
      <div class="logo">
        <div class="logo-icon">üó∫Ô∏è</div>
        <span class="logo-text">Roadmap AI</span>
      </div>
      <h1 id="wizardTitle">AI Learning Plan<br/>Generator</h1>
      <p class="subtitle" id="wizardSubtitle">Answer 5 questions ‚Üí get your personalized plan</p>
    </header>

    <!-- Mode tabs -->
    <div class="mode-tabs">
      <button class="mode-tab active" id="tabPlan" onclick="switchWizardMode('plan')">üìã Plan</button>
      <button class="mode-tab" id="tabCourse" onclick="switchWizardMode('course')">üìñ Course</button>
      <button class="mode-tab" id="tabGuide" onclick="switchWizardMode('guide')">üìÑ Guide</button>
      <button class="mode-tab" id="tabRoadmap" onclick="switchWizardMode('roadmap')">üó∫Ô∏è Roadmap</button>
      <button class="mode-tab" id="tabQuiz" onclick="switchWizardMode('quiz')">üß† Quiz</button>
    </div>

    <!-- Plan wizard -->
    <div id="planWizard">
      <div class="progress-track" id="progressTrack"></div>
      <div class="q-card" id="questionCard"></div>
    </div>

    <!-- Course creator wizard -->
    <div id="courseCreatorWizard">
      <div class="q-card">
        <div class="course-creator-label">What can I help you learn?</div>
        <input class="course-topic-input" id="courseTopicInput" type="text"
          placeholder="e.g., Chess, Machine Learning, JavaScript, Photography..."
          oninput="updateCourseGenBtn()" />

        <div class="course-creator-label">Choose the format</div>
        <div class="format-cards" id="wizardCourseFormatCards">
          <div class="format-card active" onclick="selectFormat(this,'wizard')">
            <span class="fc-icon">üìñ</span>
            <span class="fc-label">Course</span>
          </div>
          <div class="format-card disabled">
            <span class="fc-icon">üìÑ</span>
            <span class="fc-label">Guide</span>
          </div>
          <div class="format-card" onclick="selectFormat(this,'wizard')">
            <span class="fc-icon">üó∫Ô∏è</span>
            <span class="fc-label">Roadmap</span>
          </div>
        </div>

        <div class="context-checkbox-row" onclick="toggleCourseContext()">
          <input type="checkbox" id="contextCheckbox" />
          <label for="contextCheckbox">Answer the following questions for a better course</label>
        </div>

        <div id="courseContextArea">
          <textarea class="context-textarea" id="courseContextInput"
            placeholder="What's your current skill level? Any specific focus areas? What do you want to achieve after this course?"></textarea>
        </div>

        <button class="btn-course-generate" id="courseGenBtn" onclick="startCourseGenerate()" disabled>
          ‚ú¶ Generate
        </button>
      </div>
    </div>

    <!-- Guide creator wizard -->
    <div id="guideCreatorWizard">
      <div class="q-card">
        <div class="course-creator-label">What can I help you learn?</div>
        <input class="course-topic-input" id="guideTopicInput" type="text"
          placeholder="e.g., JavaScript, Cryptocurrency, Photography, Chess..."
          oninput="updateGuideGenBtn()" />

        <div id="guidePersonalization">
          <div class="personalization-group">
            <div class="course-creator-label">Skill level <button class="skip-link" onclick="skipGuidePersonalization()">Skip personalization ‚Üí</button></div>
            <div class="chip-row">
              <div class="chip" onclick="selectGuideChip(this,'level','Beginner')">üå± Beginner</div>
              <div class="chip" onclick="selectGuideChip(this,'level','Intermediate')">‚ö° Intermediate</div>
              <div class="chip" onclick="selectGuideChip(this,'level','Advanced')">üî• Advanced</div>
              <input class="chip-custom" id="guideCustomLevel" placeholder="Custom..." oninput="setGuideCustomChip('level',this.value)" />
            </div>
          </div>
          <div class="personalization-group">
            <div class="course-creator-label">Learning style</div>
            <div class="chip-row">
              <div class="chip" onclick="selectGuideChip(this,'style','Visual')">üëÅ Visual</div>
              <div class="chip" onclick="selectGuideChip(this,'style','Auditory')">üëÇ Auditory</div>
              <div class="chip" onclick="selectGuideChip(this,'style','Kinesthetic')">ü§ù Kinesthetic</div>
              <input class="chip-custom" id="guideCustomStyle" placeholder="Custom..." oninput="setGuideCustomChip('style',this.value)" />
            </div>
          </div>
          <div class="personalization-group">
            <div class="course-creator-label">What would you like to achieve?</div>
            <div class="chip-row">
              <div class="chip" onclick="selectGuideChip(this,'goal','Build projects')">üöÄ Build projects</div>
              <div class="chip" onclick="selectGuideChip(this,'goal','Learn theory')">üìö Learn theory</div>
              <div class="chip" onclick="selectGuideChip(this,'goal','Get certified')">üèÜ Get certified</div>
              <div class="chip" onclick="selectGuideChip(this,'goal','Career change')">üíº Career change</div>
              <input class="chip-custom" id="guideCustomGoal" placeholder="Custom..." oninput="setGuideCustomChip('goal',this.value)" />
            </div>
          </div>
        </div>

        <button class="btn-course-generate" id="guideGenBtn" onclick="startGuideGenerate()" disabled>
          ‚ú¶ Generate Guide
        </button>
      </div>
    </div>

    <!-- Roadmap creator wizard -->
    <div id="roadmapCreatorWizard">
      <div class="q-card">
        <div class="course-creator-label">What can I help you learn?</div>
        <input class="course-topic-input" id="roadmapTopicInput" type="text"
          placeholder="e.g., Web Development, Machine Learning, Data Science, DevOps..."
          oninput="updateRoadmapWizardBtn()" />

        <div class="course-creator-label">Choose the format</div>
        <div class="format-cards">
          <div class="format-card disabled">
            <span class="fc-icon">üìñ</span>
            <span class="fc-label">Course</span>
          </div>
          <div class="format-card disabled">
            <span class="fc-icon">üìÑ</span>
            <span class="fc-label">Guide</span>
          </div>
          <div class="format-card active">
            <span class="fc-icon">üó∫Ô∏è</span>
            <span class="fc-label">Roadmap</span>
          </div>
        </div>

        <div class="context-checkbox-row" onclick="toggleRoadmapContext()">
          <input type="checkbox" id="roadmapContextCheckbox" />
          <label for="roadmapContextCheckbox">Answer the following questions for a better roadmap</label>
        </div>
        <div id="roadmapContextArea" style="display:none; margin-bottom:6px;">
          <textarea class="context-textarea" id="roadmapContextInput"
            placeholder="What's your current skill level? Career goals? Time commitment? Any areas to focus on or avoid?"></textarea>
        </div>

        <button class="btn-course-generate" id="roadmapWizardGenBtn" onclick="startWizardRoadmapGenerate()" disabled>
          ‚ú¶ Generate Roadmap
        </button>
      </div>
    </div>

    <!-- Quiz creator wizard -->
    <div id="quizCreatorWizard">
      <div class="q-card">
        <div class="course-creator-label">What topic would you like to quiz yourself on?</div>
        <input class="course-topic-input" id="quizTopicInput" type="text"
          placeholder="e.g., JavaScript Variables, Go Routines, System Design, Photosynthesis..."
          oninput="updateQuizWizardBtn()" />

        <div class="course-creator-label">Choose the format</div>
        <div class="format-cards">
          <div class="format-card active" id="quizWizardFormatActive">
            <span class="fc-icon">‚òëÔ∏è</span>
            <span class="fc-label">Multi-Choice</span>
          </div>
          <div class="format-card disabled">
            <span class="fc-icon">üìù</span>
            <span class="fc-label">Open-Ended</span>
          </div>
          <div class="format-card disabled">
            <span class="fc-icon">üîÄ</span>
            <span class="fc-label">Mixed</span>
          </div>
        </div>

        <div class="context-checkbox-row" onclick="toggleQuizWizardContext()">
          <input type="checkbox" id="quizWizardContextCheckbox" />
          <label for="quizWizardContextCheckbox">Answer the following questions for a better result</label>
        </div>
        <div id="quizWizardContextArea" style="display:none; margin-bottom:6px;">
          <textarea class="context-textarea" id="quizWizardContextInput"
            placeholder="Your skill level? Specific areas to focus on? Number of questions? Difficulty?"></textarea>
        </div>

        <button class="btn-course-generate" id="quizWizardGenBtn" onclick="startWizardQuizGenerate()" disabled>
          ‚ú¶ Generate Quiz
        </button>
      </div>
    </div>

  </div>
</div>

<!-- LOADING -->
<div id="loadingPage" style="display:none;min-height:100vh;place-items:center;text-align:center;padding:20px;position:relative;z-index:1;">
  <div>
    <div class="loader-ring"></div>
    <div class="loading-title">Building your learning plan<span class="loading-dots"></span></div>
    <div class="loading-sub" id="loadingStatus">Analyzing your goals</div>
  </div>
</div>

<!-- APP -->
<div id="appPage" style="display:none;">
  <div class="app-layout">

    <!-- SIDEBAR -->
    <aside class="app-sidebar">
      <div class="sidebar-brand">
        <div class="brand-logo">üó∫Ô∏è</div>
        <div class="brand-name">Roadmap AI</div>
        <div class="brand-sub">Your personalized learning companion</div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-section-label">Create with AI</div>
        <div class="sidebar-item active" id="navPlan" onclick="showPlanView()">
          <span class="item-icon">üìã</span> Plan
        </div>
        <div class="sidebar-item" id="navCourse" onclick="showCourseCreatorApp()">
          <span class="item-icon">üìñ</span> Course
        </div>
        <div class="sidebar-item" id="navGuide" onclick="showGuideCreatorApp()">
          <span class="item-icon">üìÑ</span> Guide
        </div>
        <div class="sidebar-item" id="navRoadmap" onclick="showRoadmapCreatorApp()">
          <span class="item-icon">üó∫Ô∏è</span> Roadmap
        </div>
        <div class="sidebar-item" id="navQuiz" onclick="showQuizCreatorApp()">
          <span class="item-icon">üß†</span> Quiz
        </div>
      </div>
      <div class="sidebar-divider"></div>
      <div id="sidebarContent"></div>
      <div class="sidebar-divider"></div>
      <div class="sidebar-section">
        <div class="sidebar-item" onclick="startOver()">
          <span class="item-icon">Ôºã</span> New Plan
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="app-main">

      <!-- PLAN VIEW -->
      <div id="planView" style="padding:40px 48px 80px;max-width:900px;">
        <div class="plan-breadcrumb" id="planBreadcrumb">Learning Plan</div>
        <div class="plan-title" id="planTitle"></div>
        <div class="plan-meta" id="planMeta"></div>
        <div class="plan-actions">
          <button class="action-btn action-btn-ghost" id="revisePlanBtn" onclick="openRevise()">‚Ü∫ Revise Plan</button>
          <button class="action-btn action-btn-danger" onclick="startOver()">üóë Remove Plan</button>
        </div>
        <div id="stepsContainer"></div>
      </div>

      <!-- COURSE CREATOR (inside app) -->
      <div id="courseCreatorApp">
        <div class="plan-breadcrumb">Create with AI</div>
        <div class="plan-title" style="margin-bottom:28px;">Create a Course</div>

        <div class="cca-label">What can I help you learn?</div>
        <input class="cca-topic-input" id="appCourseTopicInput" type="text"
          placeholder="e.g., Chess, Machine Learning, JavaScript, Photography..."
          oninput="updateAppCourseGenBtn()" />

        <div class="course-creator-label">Choose the format</div>
        <div class="format-cards" id="appCourseFormatCards" style="margin-bottom:20px;">
          <div class="format-card active" onclick="selectFormat(this,'app')">
            <span class="fc-icon">üìñ</span><span class="fc-label">Course</span>
          </div>
          <div class="format-card disabled">
            <span class="fc-icon">üìÑ</span><span class="fc-label">Guide</span>
          </div>
          <div class="format-card" onclick="selectFormat(this,'app')">
            <span class="fc-icon">üó∫Ô∏è</span><span class="fc-label">Roadmap</span>
          </div>
        </div>

        <div class="context-checkbox-row" onclick="toggleAppCourseContext()">
          <input type="checkbox" id="appContextCheckbox" />
          <label for="appContextCheckbox">Answer the following questions for a better course</label>
        </div>
        <div id="appCourseContextArea" style="display:none;margin-bottom:6px;">
          <textarea class="context-textarea" id="appCourseContextInput"
            placeholder="What's your current skill level? Any specific focus areas? What do you want to achieve?"></textarea>
        </div>

        <button class="btn-course-generate" id="appCourseGenBtn" onclick="startAppCourseGenerate()" disabled>
          ‚ú¶ Generate
        </button>
      </div>

      <!-- GUIDE CREATOR (inside app) -->
      <div id="guideCreatorApp">
        <div class="plan-breadcrumb">Create with AI</div>
        <div class="plan-title" style="margin-bottom:28px;">Create a Guide</div>

        <div class="course-creator-label">What can I help you learn?</div>
        <input class="cca-topic-input" id="appGuideTopicInput" type="text"
          placeholder="e.g., JavaScript, Cryptocurrency, Photography, Chess..."
          oninput="updateAppGuideGenBtn()" />

        <div id="appGuidePersonalization">
          <div class="personalization-group">
            <div class="course-creator-label">Skill level <button class="skip-link" onclick="skipAppGuidePersonalization()">Skip ‚Üí</button></div>
            <div class="chip-row">
              <div class="chip" onclick="selectAppGuideChip(this,'level','Beginner')">üå± Beginner</div>
              <div class="chip" onclick="selectAppGuideChip(this,'level','Intermediate')">‚ö° Intermediate</div>
              <div class="chip" onclick="selectAppGuideChip(this,'level','Advanced')">üî• Advanced</div>
              <input class="chip-custom" id="appGuideCustomLevel" placeholder="Custom..." oninput="setAppGuideCustomChip('level',this.value)" />
            </div>
          </div>
          <div class="personalization-group">
            <div class="course-creator-label">Learning style</div>
            <div class="chip-row">
              <div class="chip" onclick="selectAppGuideChip(this,'style','Visual')">üëÅ Visual</div>
              <div class="chip" onclick="selectAppGuideChip(this,'style','Auditory')">üëÇ Auditory</div>
              <div class="chip" onclick="selectAppGuideChip(this,'style','Kinesthetic')">ü§ù Kinesthetic</div>
              <input class="chip-custom" id="appGuideCustomStyle" placeholder="Custom..." oninput="setAppGuideCustomChip('style',this.value)" />
            </div>
          </div>
          <div class="personalization-group">
            <div class="course-creator-label">What would you like to achieve?</div>
            <div class="chip-row">
              <div class="chip" onclick="selectAppGuideChip(this,'goal','Build projects')">üöÄ Build projects</div>
              <div class="chip" onclick="selectAppGuideChip(this,'goal','Learn theory')">üìö Learn theory</div>
              <div class="chip" onclick="selectAppGuideChip(this,'goal','Get certified')">üèÜ Get certified</div>
              <div class="chip" onclick="selectAppGuideChip(this,'goal','Career change')">üíº Career change</div>
              <input class="chip-custom" id="appGuideCustomGoal" placeholder="Custom..." oninput="setAppGuideCustomChip('goal',this.value)" />
            </div>
          </div>
        </div>

        <button class="btn-course-generate" id="appGuideGenBtn" onclick="startAppGuideGenerate()" disabled>
          ‚ú¶ Generate Guide
        </button>
      </div>

      <!-- ROADMAP CREATOR (inside app) -->
      <div id="roadmapCreatorApp">
        <div class="plan-breadcrumb">Create with AI</div>
        <div class="plan-title" style="margin-bottom:28px;">Create a Roadmap</div>

        <div class="course-creator-label">What can I help you learn?</div>
        <input class="cca-topic-input" id="appRoadmapTopicInput" type="text"
          placeholder="e.g., Web Development, Machine Learning, Data Science, DevOps..."
          oninput="updateAppRoadmapGenBtn()" />

        <div class="course-creator-label">Choose the format</div>
        <div class="format-cards" style="margin-bottom:20px;">
          <div class="format-card disabled">
            <span class="fc-icon">üìñ</span><span class="fc-label">Course</span>
          </div>
          <div class="format-card disabled">
            <span class="fc-icon">üìÑ</span><span class="fc-label">Guide</span>
          </div>
          <div class="format-card active">
            <span class="fc-icon">üó∫Ô∏è</span><span class="fc-label">Roadmap</span>
          </div>
        </div>

        <div class="context-checkbox-row" onclick="toggleAppRoadmapContext()">
          <input type="checkbox" id="appRoadmapContextCheckbox" />
          <label for="appRoadmapContextCheckbox">Answer the following questions for a better roadmap</label>
        </div>
        <div id="appRoadmapContextArea" style="display:none; margin-bottom:6px;">
          <textarea class="context-textarea" id="appRoadmapContextInput"
            placeholder="What's your current skill level? Career goals? Areas to focus on or avoid?"></textarea>
        </div>

        <button class="btn-course-generate" id="appRoadmapGenBtn" onclick="startAppRoadmapGenerate()" disabled>
          ‚ú¶ Generate Roadmap
        </button>
      </div>

      <!-- QUIZ CREATOR (inside app) -->
      <div id="quizCreatorApp">
        <div class="plan-breadcrumb">Create with AI</div>
        <div class="plan-title" style="margin-bottom:6px;">Test your Knowledge</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:28px;">Create a personalized quiz to test your understanding of any topic</div>

        <div class="course-creator-label">What topic would you like to quiz yourself on?</div>
        <input class="cca-topic-input" id="appQuizTopicInput" type="text"
          placeholder="e.g., JavaScript Variables, Go Routines, System Design..."
          oninput="updateAppQuizGenBtn()" />

        <div class="course-creator-label">Choose the format</div>
        <div class="format-cards" style="margin-bottom:20px;">
          <div class="format-card active">
            <span class="fc-icon">‚òëÔ∏è</span><span class="fc-label">Multi-Choice</span>
          </div>
          <div class="format-card disabled">
            <span class="fc-icon">üìù</span><span class="fc-label">Open-Ended</span>
          </div>
          <div class="format-card disabled">
            <span class="fc-icon">üîÄ</span><span class="fc-label">Mixed</span>
          </div>
        </div>

        <div class="context-checkbox-row" onclick="toggleAppQuizContext()">
          <input type="checkbox" id="appQuizContextCheckbox" />
          <label for="appQuizContextCheckbox">Answer the following questions for a better result</label>
        </div>
        <div id="appQuizContextArea" style="display:none; margin-bottom:6px;">
          <textarea class="context-textarea" id="appQuizContextInput"
            placeholder="Your skill level? Specific subtopics? Number of questions (default 10)? Difficulty?"></textarea>
        </div>

        <button class="btn-course-generate" id="appQuizGenBtn" onclick="startAppQuizGenerate()" disabled>
          ‚ú¶ Generate Quiz
        </button>
      </div>

      <!-- QUIZ VIEW -->
      <div id="quizView">
        <div class="quiz-layout">
          <div class="quiz-main">
            <button class="back-btn" onclick="showQuizCreatorApp()">‚Üê Create New Quiz</button>
            <div class="quiz-header">
              <div class="quiz-label">üß† Quiz</div>
              <div class="quiz-title" id="quizTitle"></div>
            </div>
            <div class="quiz-progress-row">
              <div class="quiz-progress-bar-wrap">
                <div class="quiz-progress-fill" id="quizProgressFill"></div>
              </div>
              <div class="quiz-progress-label" id="quizProgressLabel"></div>
            </div>
            <!-- Active question -->
            <div id="quizQuestionArea"></div>
            <!-- Results -->
            <div id="quizResultsArea" style="display:none;"></div>
          </div>
        </div>
      </div>

      <!-- GUIDE VIEW -->
      <div id="guideView">
        <div class="guide-layout">
          <div class="guide-main" id="guideMain">
            <button class="back-btn" onclick="showGuideCreatorApp()">‚Üê Create New Guide</button>
            <div class="guide-header">
              <div class="guide-label">Guide</div>
              <div class="guide-title" id="guideTitle"></div>
              <div class="guide-prefs" id="guidePrefs"></div>
              <div style="margin-top:16px;display:flex;gap:10px;">
                <button class="action-btn action-btn-ghost" onclick="openRevise()">‚Ü∫ Revise Guide</button>
                <button class="action-btn action-btn-danger" onclick="showGuideCreatorApp()">üóë Remove</button>
              </div>
            </div>
            <div id="guideSectionsContainer"></div>
            <div class="guide-feedback" id="guideFeedback" style="display:none;">
              <span class="guide-feedback-q">Was this guide helpful?</span>
              <button class="feedback-btn yes" onclick="handleFeedback(true)">üëç Yes</button>
              <button class="feedback-btn no" onclick="handleFeedback(false)">üëé No</button>
            </div>
            <div class="related-topics" id="guideRelated" style="display:none;">
              <div class="related-label">Explore further</div>
              <div class="related-list" id="guideRelatedList"></div>
            </div>
          </div>

          <!-- GUIDE AI ASSISTANT -->
          <div class="ai-instructor" id="guideInstructor">
            <div class="instructor-header">
              <div class="instructor-dot"></div>
              <div class="instructor-title-text">AI Assistant</div>
            </div>
            <div class="instructor-messages" id="guideMessages"></div>
            <div class="suggested-qs" id="guideSuggestedQs"></div>
            <div class="instructor-input-area">
              <textarea class="instructor-input" id="guideInput"
                placeholder="Ask anything about this guide..."
                onkeydown="handleGuideKey(event)"
                oninput="autoResize(this)" rows="1"></textarea>
              <button class="send-btn" id="guideSendBtn" onclick="sendGuideMessage()">‚û§</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ROADMAP VIEW -->
      <div id="roadmapView">
        <div class="roadmap-layout">
          <!-- Scrollable main area -->
          <div class="roadmap-scroll-area" id="roadmapScrollArea">
            <button class="back-btn" onclick="showRoadmapCreatorApp()">‚Üê Create New Roadmap</button>
            <div class="roadmap-header">
              <div class="guide-label">üó∫Ô∏è Roadmap</div>
              <div class="guide-title" id="roadmapTitle"></div>
              <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="action-btn action-btn-ghost" onclick="openRevise()">‚Ü∫ Revise Roadmap</button>
                <button class="action-btn action-btn-danger" onclick="showRoadmapCreatorApp()">üóë Remove</button>
              </div>
            </div>
            <!-- Canvas -->
            <div class="roadmap-canvas-wrapper">
              <div class="roadmap-canvas" id="roadmapCanvas"></div>
            </div>
          </div>

          <!-- AI TUTOR PANEL -->
          <div class="rm-ai-panel">
            <div class="instructor-header">
              <div class="instructor-dot" style="background:var(--gold);box-shadow:0 0 6px var(--gold);"></div>
              <div class="instructor-title-text">AI Tutor</div>
            </div>
            <div class="instructor-messages" id="roadmapMessages">
              <div class="rm-empty-state">
                <div class="rm-empty-icon">üó∫Ô∏è</div>
                <div class="rm-empty-text">Click any node on the roadmap to learn about that topic</div>
              </div>
            </div>
            <div class="suggested-qs" id="roadmapSuggestedQs"></div>
            <div class="instructor-input-area">
              <textarea class="instructor-input" id="roadmapInput"
                placeholder="Ask about this roadmap..."
                onkeydown="handleRoadmapKey(event)"
                oninput="autoResize(this)" rows="1"></textarea>
              <button class="send-btn" id="roadmapSendBtn" onclick="sendRoadmapMessage()">‚û§</button>
            </div>
          </div>
        </div>
      </div>

      <!-- LESSON VIEW -->
      <div id="lessonView" style="display:none;">
        <div class="lesson-layout">
          <div class="lesson-main">
            <button class="back-btn" onclick="showPlanView()">‚Üê Back to Outline</button>
            <div class="lesson-title" id="lessonTitle"></div>
            <div class="lesson-meta" id="lessonMeta"></div>
            <div class="lesson-progress-bar"><div class="lesson-progress-fill" id="lessonProgressFill"></div></div>
            <div class="lesson-content" id="lessonBody"></div>
          </div>

          <!-- AI INSTRUCTOR -->
          <div class="ai-instructor">
            <div class="instructor-header">
              <div class="instructor-dot"></div>
              <div class="instructor-title-text">AI Instructor</div>
            </div>
            <div class="instructor-messages" id="instructorMessages"></div>
            <div class="suggested-qs" id="suggestedQs"></div>
            <div class="instructor-input-area">
              <textarea class="instructor-input" id="instructorInput"
                placeholder="Ask about this lesson..."
                onkeydown="handleInstructorKey(event)"
                oninput="autoResize(this)" rows="1"></textarea>
              <button class="send-btn" id="sendBtn" onclick="sendInstructorMessage()">‚û§</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<script>
const GROQ_API_KEY = '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';
const GROQ_MODEL = 'llama-3.3-70b-versatile';

const QUESTIONS = [
  { id:'goal', number:'Question 1 of 5', title:'What is your main learning goal?', type:'options',
    options:[{icon:'üíº',label:'Get a Job'},{icon:'üìà',label:'Grow in my current role'},{icon:'üöÄ',label:'Build Projects / Side Hustles'},{icon:'üß±',label:'Strengthen Fundamentals'},{icon:'üî≠',label:'Explore a New Field'}]},
  { id:'field', number:'Question 2 of 5', title:'What role or field do you want to focus on?', type:'textarea',
    placeholder:'e.g., "Backend developer with Node.js", "Machine learning engineer", "Frontend React developer"...'},
  { id:'level', number:'Question 3 of 5', title:'What is your current skill level?', type:'options',
    options:[{icon:'üå±',label:'Beginner',desc:'Just starting out'},{icon:'‚ö°',label:'Intermediate',desc:'Some hands-on experience'},{icon:'üî•',label:'Advanced',desc:'Comfortable, want to go deeper'}]},
  { id:'focus', number:'Question 4 of 5', title:'Anything specific to focus on or avoid?', type:'textarea',
    placeholder:'e.g., "Focus on vanilla JS, avoid frameworks", "Include Docker and CI/CD", "Skip heavy theory"...'},
  { id:'extra', number:'Question 5 of 5', title:'Anything else about your goals?', type:'textarea',
    placeholder:'Timeline, background, career goals, preferences...'}
];
const STEP_LABELS = ['Goal','Field','Level','Focus','Context'];

let current = 0, answers = {}, planData = null;
let currentCourse = null, instructorHistory = [], loadingInterval;
let activeMode = 'plan';
let guideData = null, guideHistory = [], guidePrefs = {};
let appGuidePrefs = {};

// ‚îÄ‚îÄ ROADMAP STATE ‚îÄ‚îÄ
let roadmapData = null;
let roadmapHistory = [];
let selectedRoadmapNodeData = null;
let selectedWizardFormat = 'course';
let selectedAppFormat = 'course';

// ‚îÄ‚îÄ FORMAT SELECTION ‚îÄ‚îÄ
function selectFormat(el, context) {
  const container = el.closest('.format-cards');
  container.querySelectorAll('.format-card:not(.disabled)').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  const label = el.querySelector('.fc-label').textContent.trim().toLowerCase();
  if (context === 'wizard') selectedWizardFormat = label;
  else selectedAppFormat = label;
  // Update button text if roadmap selected
  if (context === 'wizard') {
    const btn = document.getElementById('courseGenBtn');
    if (btn) btn.textContent = label === 'roadmap' ? '‚ú¶ Generate Roadmap' : '‚ú¶ Generate';
  } else {
    const btn = document.getElementById('appCourseGenBtn');
    if (btn) btn.textContent = label === 'roadmap' ? '‚ú¶ Generate Roadmap' : '‚ú¶ Generate';
  }
}

// ‚îÄ‚îÄ WIZARD MODE SWITCHING ‚îÄ‚îÄ
function switchWizardMode(mode) {
  activeMode = mode;
  ['plan','course','guide','roadmap'].forEach(m => {
    const tab = document.getElementById('tab' + m.charAt(0).toUpperCase() + m.slice(1));
    if (tab) tab.classList.toggle('active', m === mode);
  });
  document.getElementById('planWizard').style.display = mode === 'plan' ? 'block' : 'none';
  document.getElementById('courseCreatorWizard').style.display = mode === 'course' ? 'block' : 'none';
  document.getElementById('guideCreatorWizard').style.display = mode === 'guide' ? 'block' : 'none';
  document.getElementById('roadmapCreatorWizard').style.display = mode === 'roadmap' ? 'block' : 'none';
  const titles = {
    plan:    ['AI Learning Plan<br/>Generator', 'Answer 5 questions ‚Üí get your personalized plan'],
    course:  ['AI Course<br/>Creator', 'Type a topic ‚Üí get a structured course'],
    guide:   ['AI Guide<br/>Creator', 'Type a topic ‚Üí get a concise guide'],
    roadmap: ['AI Roadmap<br/>Creator', 'Type a topic ‚Üí get a visual learning roadmap']
  };
  document.getElementById('wizardTitle').innerHTML = titles[mode][0];
  document.getElementById('wizardSubtitle').textContent = titles[mode][1];
}

// ‚îÄ‚îÄ GUIDE PERSONALIZATION (WIZARD) ‚îÄ‚îÄ
function selectGuideChip(el, key, value) {
  const row = el.closest('.chip-row');
  row.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  guidePrefs[key] = value;
  const customInput = row.querySelector('.chip-custom');
  if (customInput) customInput.value = '';
}
function setGuideCustomChip(key, value) {
  guidePrefs[key] = value || undefined;
  const inputEl = document.getElementById(`guideCustom${key.charAt(0).toUpperCase()+key.slice(1)}`);
  if (inputEl) {
    inputEl.closest('.chip-row').querySelectorAll('.chip').forEach(c => {
      if (value) c.classList.remove('selected');
    });
  }
}
function skipGuidePersonalization() {
  guidePrefs = {};
  document.getElementById('guidePersonalization').style.display = 'none';
}

// ‚îÄ‚îÄ GUIDE PERSONALIZATION (APP) ‚îÄ‚îÄ
function selectAppGuideChip(el, key, value) {
  const row = el.closest('.chip-row');
  row.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  appGuidePrefs[key] = value;
  const customInput = row.querySelector('.chip-custom');
  if (customInput) customInput.value = '';
}
function setAppGuideCustomChip(key, value) {
  appGuidePrefs[key] = value || undefined;
  const inputEl = document.getElementById(`appGuideCustom${key.charAt(0).toUpperCase()+key.slice(1)}`);
  if (inputEl) {
    if (value) inputEl.closest('.chip-row').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
  }
}
function skipAppGuidePersonalization() {
  appGuidePrefs = {};
  document.getElementById('appGuidePersonalization').style.display = 'none';
}
function updateGuideGenBtn() {
  document.getElementById('guideGenBtn').disabled = !document.getElementById('guideTopicInput').value.trim();
}
function updateAppGuideGenBtn() {
  document.getElementById('appGuideGenBtn').disabled = !document.getElementById('appGuideTopicInput').value.trim();
}
async function startGuideGenerate() {
  const topic = document.getElementById('guideTopicInput').value.trim();
  if (!topic) return;
  await runGuideGeneration(topic, guidePrefs);
}
async function startAppGuideGenerate() {
  const topic = document.getElementById('appGuideTopicInput').value.trim();
  if (!topic) return;
  await runGuideGeneration(topic, appGuidePrefs);
}

// ‚îÄ‚îÄ GUIDE CREATOR APP VIEW ‚îÄ‚îÄ
function showGuideCreatorApp() {
  hideAllMainViews();
  document.getElementById('guideCreatorApp').style.display = 'block';
  setNavActive('navGuide');
  document.getElementById('sidebarContent').innerHTML = '';
  document.getElementById('appGuideTopicInput').value = '';
  document.getElementById('appGuideGenBtn').disabled = true;
  appGuidePrefs = {};
  document.getElementById('appGuidePersonalization').style.display = 'block';
  document.getElementById('appGuidePersonalization').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
  ['appGuideCustomLevel','appGuideCustomStyle','appGuideCustomGoal'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
}

// ‚îÄ‚îÄ ROADMAP CREATOR APP VIEW ‚îÄ‚îÄ
function showRoadmapCreatorApp() {
  hideAllMainViews();
  document.getElementById('roadmapCreatorApp').style.display = 'block';
  setNavActive('navRoadmap');
  document.getElementById('sidebarContent').innerHTML = '';
  document.getElementById('appRoadmapTopicInput').value = '';
  document.getElementById('appRoadmapGenBtn').disabled = true;
  selectedAppFormat = 'roadmap';
}

function updateAppRoadmapGenBtn() {
  document.getElementById('appRoadmapGenBtn').disabled = !document.getElementById('appRoadmapTopicInput').value.trim();
}
function toggleAppRoadmapContext() {
  const cb = document.getElementById('appRoadmapContextCheckbox');
  cb.checked = !cb.checked;
  document.getElementById('appRoadmapContextArea').style.display = cb.checked ? 'block' : 'none';
}
function updateRoadmapWizardBtn() {
  document.getElementById('roadmapWizardGenBtn').disabled = !document.getElementById('roadmapTopicInput').value.trim();
}
function toggleRoadmapContext() {
  const cb = document.getElementById('roadmapContextCheckbox');
  cb.checked = !cb.checked;
  document.getElementById('roadmapContextArea').style.display = cb.checked ? 'block' : 'none';
}
async function startWizardRoadmapGenerate() {
  const topic = document.getElementById('roadmapTopicInput').value.trim();
  if (!topic) return;
  const context = document.getElementById('roadmapContextCheckbox').checked
    ? document.getElementById('roadmapContextInput').value.trim() : '';
  await runRoadmapGeneration(topic, context);
}
async function startAppRoadmapGenerate() {
  const topic = document.getElementById('appRoadmapTopicInput').value.trim();
  if (!topic) return;
  const context = document.getElementById('appRoadmapContextCheckbox').checked
    ? document.getElementById('appRoadmapContextInput').value.trim() : '';
  await runRoadmapGeneration(topic, context);
}

// ‚îÄ‚îÄ GUIDE GENERATION ‚îÄ‚îÄ
async function runGuideGeneration(topic, prefs = {}) {
  activeMode = 'guide';
  hideAllMainViews();
  document.getElementById('wizardPage').style.display = 'none';
  document.getElementById('appPage').style.display = 'none';
  const lp = document.getElementById('loadingPage');
  lp.style.display = 'grid';
  lp.querySelector('.loading-title').innerHTML = 'Crafting your guide<span class="loading-dots"></span>';

  let i = 0;
  const lsEl = document.getElementById('loadingStatus');
  const msgs = ['Researching the topic','Writing introduction','Building core concepts','Adding examples','Compiling advanced topics'];
  lsEl.textContent = msgs[0];
  loadingInterval = setInterval(() => { lsEl.textContent = msgs[++i % msgs.length]; }, 1800);

  const prefsText = [
    prefs.level && `Skill level: ${prefs.level}`,
    prefs.style && `Learning style: ${prefs.style}`,
    prefs.goal  && `Goal: ${prefs.goal}`
  ].filter(Boolean).join(', ');

  try {
    const prompt = `You are an expert educator. Create a comprehensive guide for "${topic}".
${prefsText ? `Personalization: ${prefsText}` : ''}

Return ONLY valid JSON (no markdown, no fences):
{
  "title": "Concise guide title (e.g. '${topic}: A Concise Guide')",
  "introduction": "2-3 paragraph HTML introduction explaining what ${topic} is, why it matters, and what this guide covers. Use <p> tags.",
  "sections": [
    {
      "badge": "Core Concepts",
      "title": "Foundational Concepts",
      "content": "HTML content with <p>, <ul>, <li>, <strong>, <code> tags. 3-5 key concepts explained clearly."
    },
    {
      "badge": "Tools & Technologies",
      "title": "Key Tools & Technologies",
      "content": "HTML content listing and explaining the most important tools/technologies for ${topic}."
    },
    {
      "badge": "Examples",
      "title": "Practical Examples",
      "content": "HTML content with real examples, code snippets in <pre><code> where relevant."
    },
    {
      "badge": "Advanced Topics",
      "title": "Advanced Features & Concepts",
      "content": "HTML content covering advanced/niche topics for those wanting to go deeper."
    }
  ],
  "relatedTopics": ["Related Topic 1", "Related Topic 2", "Related Topic 3", "Related Topic 4"]
}

Make content rich, practical, and tailored${prefsText ? ` to the ${prefsText}` : ''}. Each section should have 150-250 words.`;

    const raw = await callGroq([{role:'user', content:prompt}], 4000);
    clearInterval(loadingInterval);

    let parsed;
    try {
      const clean = raw.replace(/```json|```/g,'').trim();
      parsed = JSON.parse(clean);
    } catch {
      const match = raw.match(/\{[\s\S]*\}/);
      if (!match) throw new Error('Could not parse guide. Please try again.');
      parsed = JSON.parse(match[0]);
    }

    guideData = parsed;
    guideData.topic = topic;
    guideData.prefs = prefs;
    guideHistory = [];

    lp.style.display = 'none';
    document.getElementById('appPage').style.display = 'block';
    renderGuideSidebar();
    renderGuideView();
    document.getElementById('guideView').style.display = 'block';
    setNavActive('navGuide');

  } catch(err) {
    clearInterval(loadingInterval);
    lp.innerHTML = `<div style="text-align:center;padding:20px;">
      <p style="color:var(--danger);font-family:'JetBrains Mono',monospace;font-size:13px;margin-bottom:20px;">Error: ${err.message}</p>
      <button class="btn btn-ghost" onclick="location.reload()">‚Üê Start Over</button>
    </div>`;
  }
}

function renderGuideSidebar() {
  const el = document.getElementById('sidebarContent');
  let html = `<div style="padding:8px 12px 4px;"><div class="sidebar-section-label">Sections</div></div>
  <div class="guide-section-nav">
    <div class="guide-nav-item active" id="gnav-intro" onclick="scrollGuideSection('guide-intro')">
      <div class="guide-nav-dot"></div>
      <div class="guide-nav-label">Introduction</div>
    </div>`;
  if (guideData?.sections) {
    guideData.sections.forEach((s,i) => {
      html += `<div class="guide-nav-item" id="gnav-${i}" onclick="scrollGuideSection('gsec-${i}')">
        <div class="guide-nav-dot"></div>
        <div class="guide-nav-label">${s.badge || s.title}</div>
      </div>`;
    });
  }
  html += `</div>`;
  el.innerHTML = html;
}

function scrollGuideSection(id) {
  document.getElementById(id)?.scrollIntoView({behavior:'smooth', block:'start'});
  document.querySelectorAll('.guide-nav-item').forEach(e => e.classList.remove('active'));
}

function renderGuideView() {
  document.getElementById('guideTitle').textContent = guideData.title;
  const prefsEl = document.getElementById('guidePrefs');
  const tags = [
    guideData.prefs?.level && `üìä ${guideData.prefs.level}`,
    guideData.prefs?.style && `üéØ ${guideData.prefs.style}`,
    guideData.prefs?.goal  && `üéì ${guideData.prefs.goal}`
  ].filter(Boolean);
  prefsEl.innerHTML = tags.map(t => `<span class="guide-pref-tag">${t}</span>`).join('');

  const container = document.getElementById('guideSectionsContainer');
  let html = '';
  html += `<div class="guide-section-block" id="guide-intro">
    <div class="guide-section-badge">üìñ Introduction</div>
    <div class="guide-content">${guideData.introduction || ''}</div>
    <div class="guide-divider"></div>
  </div>`;
  guideData.sections.forEach((section, i) => {
    html += `<div class="guide-section-block" id="gsec-${i}">
      <div class="guide-section-badge">${section.badge || `Section ${i+1}`}</div>
      <div class="guide-section-title">${section.title}</div>
      <div class="guide-content">${section.content}</div>
      ${i < guideData.sections.length - 1 ? '<div class="guide-divider"></div>' : ''}
    </div>`;
  });
  container.innerHTML = html;

  setTimeout(() => {
    document.getElementById('guideFeedback').style.display = 'flex';
    if (guideData.relatedTopics?.length) {
      const rel = document.getElementById('guideRelated');
      const list = document.getElementById('guideRelatedList');
      list.innerHTML = guideData.relatedTopics.map(t =>
        `<div class="related-tag" onclick="runGuideGeneration('${t.replace(/'/g,"\\'")}', {})">${t}</div>`
      ).join('');
      rel.style.display = 'block';
    }
  }, 200);

  initGuideAssistant();
}

async function initGuideAssistant() {
  const msgs = document.getElementById('guideMessages');
  msgs.innerHTML = '';
  document.getElementById('guideSuggestedQs').innerHTML = '';
  addGuideMsg('ai', `Hello! I'm your AI Assistant for <strong>${guideData.title}</strong>. Ask me anything about this topic ‚Äî I'll give you clear, focused answers.`);

  try {
    const sqRaw = await callGroq([{role:'user', content:`Generate 4 short questions a learner might ask after reading a guide about "${guideData.topic}". Return JSON array only: ["Q1","Q2","Q3","Q4"]`}], 300);
    const match = sqRaw.match(/\[[\s\S]*?\]/);
    const qs = match ? JSON.parse(match[0]) : [];
    renderGuideSuggestedQs(qs.length ? qs : defaultGuideQs());
  } catch {
    renderGuideSuggestedQs(defaultGuideQs());
  }
}

function defaultGuideQs() {
  const t = guideData?.topic || 'this topic';
  return [`What are the most important concepts in ${t}?`, `How do I get started with ${t}?`, `What are common mistakes beginners make?`, `What should I learn after this guide?`];
}

function renderGuideSuggestedQs(qs) {
  const el = document.getElementById('guideSuggestedQs');
  let html = `<div class="suggested-label">Suggested questions</div>`;
  qs.forEach(q => {
    html += `<button class="sugg-q" onclick="askGuideSuggested(this,'${q.replace(/'/g,"\\'").replace(/"/g,'\\"')}')">${q}</button>`;
  });
  el.innerHTML = html;
}

function askGuideSuggested(btn, q) {
  btn.disabled = true; btn.style.opacity = '0.4';
  document.getElementById('guideInput').value = q;
  sendGuideMessage();
}

function addGuideMsg(role, html) {
  const msgs = document.getElementById('guideMessages');
  const div = document.createElement('div');
  div.className = `msg msg-${role}`;
  div.innerHTML = `<div class="msg-avatar">${role==='ai'?'ü§ñ':'üë§'}</div><div class="msg-bubble">${html}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function addGuideTyping() {
  const msgs = document.getElementById('guideMessages');
  const div = document.createElement('div');
  div.id = 'guideTyping'; div.className = 'msg msg-ai typing-indicator';
  div.innerHTML = `<div class="msg-avatar">ü§ñ</div><div class="msg-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
}

async function sendGuideMessage() {
  const input = document.getElementById('guideInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = ''; autoResize(input);
  document.getElementById('guideSendBtn').disabled = true;
  addGuideMsg('user', text);
  addGuideTyping();
  guideHistory.push({role:'user', content:text});

  try {
    const reply = await callGroq([
      {role:'system', content:`You are an AI Assistant for the guide "${guideData?.title}" about "${guideData?.topic}". ${guideData?.prefs?.level ? `Reader level: ${guideData.prefs.level}.` : ''} Be helpful, concise (under 130 words unless a code example is needed). Use **bold** for key terms.`},
      ...guideHistory
    ], 500);
    document.getElementById('guideTyping')?.remove();
    guideHistory.push({role:'assistant', content:reply});
    addGuideMsg('ai', reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'));
  } catch(err) {
    document.getElementById('guideTyping')?.remove();
    addGuideMsg('ai', `Sorry, error: ${err.message}`);
  }
  document.getElementById('guideSendBtn').disabled = false;
}

function handleGuideKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGuideMessage(); }
}

function handleFeedback(positive) {
  const fb = document.getElementById('guideFeedback');
  fb.innerHTML = `<span style="color:${positive ? 'var(--accent2)' : 'var(--muted)'};font-weight:600;">
    ${positive ? 'üëç Thanks for your feedback!' : 'üëé Thanks! We\'ll use this to improve.'}</span>`;
}

// ‚îÄ‚îÄ ROADMAP GENERATION ‚îÄ‚îÄ
async function runRoadmapGeneration(topic, context = '') {
  activeMode = 'roadmap';
  document.getElementById('wizardPage').style.display = 'none';
  document.getElementById('appPage').style.display = 'none';
  const lp = document.getElementById('loadingPage');
  lp.style.display = 'grid';
  lp.querySelector('.loading-title').innerHTML = 'Building your roadmap<span class="loading-dots"></span>';

  let i = 0;
  const lsEl = document.getElementById('loadingStatus');
  const msgs2 = ['Mapping the topic','Identifying key concepts','Organizing the structure','Building connections','Finalizing your roadmap'];
  lsEl.textContent = msgs2[0];
  loadingInterval = setInterval(() => { lsEl.textContent = msgs2[++i % msgs2.length]; }, 1800);

  try {
    const prompt = `You are an expert curriculum designer. Create a detailed visual learning roadmap for "${topic}".
${context ? `Additional context: ${context}` : ''}

Return ONLY valid JSON (no markdown fences, no explanation):
{
  "title": "${topic}: Complete Learning Roadmap",
  "sections": [
    {
      "category": "Category Name (e.g. Fundamentals, Tools, Advanced Topics)",
      "mainNode": "Central topic (3-5 words max)",
      "leftNodes": ["Related topic 1", "Related topic 2", "Related topic 3", "Related topic 4", "Related topic 5"],
      "rightNodes": ["Specific skill 1", "Specific skill 2", "Specific skill 3", "Specific skill 4", "Specific skill 5"]
    }
  ]
}

Create 6-8 sections covering the full learning journey from beginner to advanced. Left nodes are prerequisites or related concepts; right nodes are specific skills/tools within the main node. Keep ALL node labels SHORT (2-5 words). Be specific and use real technology/concept names relevant to ${topic}.`;

    const raw = await callGroq([{role:'user', content:prompt}], 4000);
    clearInterval(loadingInterval);

    let parsed;
    try {
      const clean = raw.replace(/```json|```/g,'').trim();
      parsed = JSON.parse(clean);
    } catch {
      const match = raw.match(/\{[\s\S]*\}/);
      if (!match) throw new Error('Could not parse roadmap. Please try again.');
      parsed = JSON.parse(match[0]);
    }

    roadmapData = parsed;
    roadmapData.topic = topic;
    roadmapHistory = [];
    selectedRoadmapNodeData = null;

    lp.style.display = 'none';
    document.getElementById('appPage').style.display = 'block';
    renderRoadmapSidebar();
    hideAllMainViews();
    document.getElementById('roadmapView').style.display = 'block';
    setNavActive('navRoadmap');
    renderRoadmapView();

  } catch(err) {
    clearInterval(loadingInterval);
    lp.innerHTML = `<div style="text-align:center;padding:20px;">
      <p style="color:var(--danger);font-family:'JetBrains Mono',monospace;font-size:13px;margin-bottom:20px;">Error: ${err.message}</p>
      <button class="btn btn-ghost" onclick="location.reload()">‚Üê Start Over</button>
    </div>`;
  }
}

function renderRoadmapSidebar() {
  const el = document.getElementById('sidebarContent');
  let html = `<div style="padding:8px 12px 4px;"><div class="sidebar-section-label">Sections</div></div>
  <div class="guide-section-nav">`;
  roadmapData.sections.forEach((s, i) => {
    html += `<div class="guide-nav-item" id="rmsnav-${i}" onclick="scrollToRmSection(${i})">
      <div class="guide-nav-dot"></div>
      <div class="guide-nav-label">${s.category}</div>
    </div>`;
  });
  html += `</div>`;
  el.innerHTML = html;
}

function scrollToRmSection(i) {
  document.getElementById(`rms-${i}`)?.scrollIntoView({behavior:'smooth', block:'start'});
  document.querySelectorAll('.guide-nav-item').forEach(e => e.classList.remove('active'));
  document.getElementById(`rmsnav-${i}`)?.classList.add('active');
}

function renderRoadmapView() {
  document.getElementById('roadmapTitle').textContent = roadmapData.title;
  const canvas = document.getElementById('roadmapCanvas');

  let html = '<svg class="rm-connections" id="rmSvg" xmlns="http://www.w3.org/2000/svg"></svg>';

  roadmapData.sections.forEach((section, si) => {
    const saf = (s) => (s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

    html += `<div class="rm-section" id="rms-${si}">
      <div class="rm-category-label">${section.category}</div>
      <div class="rm-grid">
        <div class="rm-left-col">`;

    (section.leftNodes || []).forEach((node, ni) => {
      html += `<div class="rm-node" id="rmnode-l-${si}-${ni}"
        onclick="selectRoadmapNode(${si},'left',${ni},'${saf(node)}','${saf(section.category)}','${saf(section.mainNode)}')"
        title="${node}">${node}</div>`;
    });

    html += `</div>
        <div class="rm-center-node" id="rmnode-c-${si}"
          onclick="selectRoadmapNode(${si},'center',-1,'${saf(section.mainNode)}','${saf(section.category)}','${saf(section.mainNode)}')"
          title="${section.mainNode}">${section.mainNode}
        </div>
        <div class="rm-right-col">`;

    (section.rightNodes || []).forEach((node, ni) => {
      html += `<div class="rm-node" id="rmnode-r-${si}-${ni}"
        onclick="selectRoadmapNode(${si},'right',${ni},'${saf(node)}','${saf(section.category)}','${saf(section.mainNode)}')"
        title="${node}">${node}</div>`;
    });

    html += `</div>
      </div>
      ${si < roadmapData.sections.length - 1 ? '<div class="rm-section-sep"></div>' : ''}
    </div>`;
  });

  canvas.innerHTML = html;

  // Draw connections after layout
  requestAnimationFrame(() => {
    requestAnimationFrame(() => drawRoadmapConnections());
  });
}

function drawRoadmapConnections() {
  const svg = document.getElementById('rmSvg');
  if (!svg || !roadmapData) return;

  const canvas = document.getElementById('roadmapCanvas');
  const canvasRect = canvas.getBoundingClientRect();
  const W = canvas.offsetWidth;
  const H = canvas.offsetHeight;

  svg.setAttribute('width', W);
  svg.setAttribute('height', H);
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.innerHTML = '';

  roadmapData.sections.forEach((section, si) => {
    const centerEl = document.getElementById(`rmnode-c-${si}`);
    if (!centerEl) return;

    const cRect = centerEl.getBoundingClientRect();
    const cxL = cRect.left - canvasRect.left;       // center node left edge x
    const cxR = cRect.right - canvasRect.left;      // center node right edge x
    const cy  = cRect.top - canvasRect.top + cRect.height / 2; // center node middle y

    // Left nodes ‚Üí center
    (section.leftNodes || []).forEach((_, ni) => {
      const el = document.getElementById(`rmnode-l-${si}-${ni}`);
      if (!el) return;
      const r = el.getBoundingClientRect();
      const nx = r.right - canvasRect.left;
      const ny = r.top - canvasRect.top + r.height / 2;

      const ctrl = nx + (cxL - nx) * 0.55;
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', `M ${nx} ${ny} C ${ctrl} ${ny}, ${ctrl} ${cy}, ${cxL} ${cy}`);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', 'rgba(100,100,130,0.3)');
      path.setAttribute('stroke-width', '1.5');
      path.setAttribute('stroke-dasharray', '5 4');
      path.setAttribute('stroke-linecap', 'round');
      svg.appendChild(path);
    });

    // Center ‚Üí right nodes
    (section.rightNodes || []).forEach((_, ni) => {
      const el = document.getElementById(`rmnode-r-${si}-${ni}`);
      if (!el) return;
      const r = el.getBoundingClientRect();
      const nx = r.left - canvasRect.left;
      const ny = r.top - canvasRect.top + r.height / 2;

      const ctrl = cxR + (nx - cxR) * 0.55;
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', `M ${cxR} ${cy} C ${ctrl} ${cy}, ${ctrl} ${ny}, ${nx} ${ny}`);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', 'rgba(100,100,130,0.3)');
      path.setAttribute('stroke-width', '1.5');
      path.setAttribute('stroke-dasharray', '5 4');
      path.setAttribute('stroke-linecap', 'round');
      svg.appendChild(path);
    });
  });
}

async function selectRoadmapNode(si, side, ni, nodeLabel, category, mainNode) {
  // Deselect all
  document.querySelectorAll('.rm-node.rm-selected, .rm-center-node.rm-selected').forEach(e => {
    e.classList.remove('rm-selected');
  });

  // Select clicked node
  let elId = side === 'center' ? `rmnode-c-${si}` :
             side === 'left'   ? `rmnode-l-${si}-${ni}` :
                                 `rmnode-r-${si}-${ni}`;
  document.getElementById(elId)?.classList.add('rm-selected');
  selectedRoadmapNodeData = { si, side, ni, nodeLabel, category, mainNode };

  // Clear empty state if first click
  const msgs = document.getElementById('roadmapMessages');
  const emptyState = msgs.querySelector('.rm-empty-state');
  if (emptyState) emptyState.remove();

  // Show what was clicked as a user-style msg
  addRoadmapMsg('user', `<strong>${nodeLabel}</strong>`);
  addRoadmapTyping();

  roadmapHistory.push({
    role: 'user',
    content: `Explain "${nodeLabel}" in the context of the "${category}" section of a ${roadmapData.topic} learning roadmap (related to "${mainNode}"). What is it, why does it matter, and how should a learner approach it?`
  });

  try {
    const reply = await callGroq([
      {role:'system', content:`You are an AI Tutor for a "${roadmapData.topic}" learning roadmap. When a user clicks a topic node, give a clear, practical explanation. Keep it under 160 words. Cover: what it is, why it's important, and 1-2 actionable tips for learning it. Use **bold** for key terms.`},
      ...roadmapHistory
    ], 450);
    document.getElementById('roadmapTyping')?.remove();
    roadmapHistory.push({role:'assistant', content:reply});
    addRoadmapMsg('ai', reply.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'));
  } catch(err) {
    document.getElementById('roadmapTyping')?.remove();
    addRoadmapMsg('ai', `Error: ${err.message}`);
  }
  document.getElementById('roadmapSendBtn').disabled = false;
}

function addRoadmapMsg(role, html) {
  const msgs = document.getElementById('roadmapMessages');
  const div = document.createElement('div');
  div.className = `msg msg-${role}`;
  div.innerHTML = `<div class="msg-avatar">${role==='ai'?'ü§ñ':'üë§'}</div><div class="msg-bubble">${html}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function addRoadmapTyping() {
  const msgs = document.getElementById('roadmapMessages');
  const div = document.createElement('div');
  div.id = 'roadmapTyping';
  div.className = 'msg msg-ai typing-indicator';
  div.innerHTML = `<div class="msg-avatar">ü§ñ</div><div class="msg-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

async function sendRoadmapMessage() {
  const input = document.getElementById('roadmapInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = ''; autoResize(input);
  document.getElementById('roadmapSendBtn').disabled = true;
  addRoadmapMsg('user', text);
  addRoadmapTyping();
  roadmapHistory.push({role:'user', content:text});

  try {
    const nodeCtx = selectedRoadmapNodeData
      ? `The user is currently looking at "${selectedRoadmapNodeData.nodeLabel}" node in the "${selectedRoadmapNodeData.category}" section.`
      : '';
    const reply = await callGroq([
      {role:'system', content:`You are an AI Tutor for a "${roadmapData.topic}" learning roadmap. ${nodeCtx} Be helpful and concise (under 130 words unless example needed). Use **bold** for key terms.`},
      ...roadmapHistory
    ], 500);
    document.getElementById('roadmapTyping')?.remove();
    roadmapHistory.push({role:'assistant', content:reply});
    addRoadmapMsg('ai', reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'));
  } catch(err) {
    document.getElementById('roadmapTyping')?.remove();
    addRoadmapMsg('ai', `Sorry, error: ${err.message}`);
  }
  document.getElementById('roadmapSendBtn').disabled = false;
}

function handleRoadmapKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendRoadmapMessage(); }
}

// Redraw connections on resize
window.addEventListener('resize', () => {
  if (roadmapData && document.getElementById('roadmapView').style.display !== 'none') {
    drawRoadmapConnections();
  }
});

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function hideAllMainViews() {
  ['planView','lessonView','courseCreatorApp','guideCreatorApp','guideView','roadmapCreatorApp','roadmapView'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
}

function setNavActive(activeId) {
  ['navPlan','navCourse','navGuide','navRoadmap'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.toggle('active', id === activeId);
  });
}

function toggleCourseContext() {
  const cb = document.getElementById('contextCheckbox');
  cb.checked = !cb.checked;
  document.getElementById('courseContextArea').style.display = cb.checked ? 'block' : 'none';
}

function updateCourseGenBtn() {
  const topic = document.getElementById('courseTopicInput').value.trim();
  document.getElementById('courseGenBtn').disabled = topic.length === 0;
}

async function startCourseGenerate() {
  const topic = document.getElementById('courseTopicInput').value.trim();
  if (!topic) return;
  if (selectedWizardFormat === 'roadmap') {
    const context = document.getElementById('contextCheckbox').checked
      ? document.getElementById('courseContextInput').value.trim() : '';
    await runRoadmapGeneration(topic, context);
    return;
  }
  const context = document.getElementById('contextCheckbox').checked
    ? document.getElementById('courseContextInput').value.trim() : '';
  await runCourseGeneration(topic, context);
}

// ‚îÄ‚îÄ COURSE CREATOR INSIDE APP ‚îÄ‚îÄ
function showCourseCreatorApp() {
  hideAllMainViews();
  document.getElementById('courseCreatorApp').style.display = 'block';
  setNavActive('navCourse');
  document.getElementById('sidebarContent').innerHTML = '';
  selectedAppFormat = 'course';
  // Reset format cards
  document.querySelectorAll('#appCourseFormatCards .format-card:not(.disabled)').forEach(c => c.classList.remove('active'));
  const firstCard = document.querySelector('#appCourseFormatCards .format-card:not(.disabled)');
  if (firstCard) firstCard.classList.add('active');
}

function toggleAppCourseContext() {
  const cb = document.getElementById('appContextCheckbox');
  cb.checked = !cb.checked;
  document.getElementById('appCourseContextArea').style.display = cb.checked ? 'block' : 'none';
}

function updateAppCourseGenBtn() {
  const topic = document.getElementById('appCourseTopicInput').value.trim();
  document.getElementById('appCourseGenBtn').disabled = topic.length === 0;
}

async function startAppCourseGenerate() {
  const topic = document.getElementById('appCourseTopicInput').value.trim();
  if (!topic) return;
  if (selectedAppFormat === 'roadmap') {
    const context = document.getElementById('appContextCheckbox').checked
      ? document.getElementById('appCourseContextInput').value.trim() : '';
    await runRoadmapGeneration(topic, context);
    return;
  }
  const context = document.getElementById('appContextCheckbox').checked
    ? document.getElementById('appCourseContextInput').value.trim() : '';
  await runCourseGeneration(topic, context);
}

async function runCourseGeneration(topic, context = '') {
  activeMode = 'course';
  document.getElementById('wizardPage').style.display = 'none';
  document.getElementById('appPage').style.display = 'none';
  const lp = document.getElementById('loadingPage');
  lp.style.display = 'grid';
  document.getElementById('loadingPage').querySelector('.loading-title').innerHTML = 'Building your course<span class="loading-dots"></span>';

  let i = 0;
  const lsEl = document.getElementById('loadingStatus');
  const msgs = ['Analyzing the topic','Structuring modules','Designing lessons','Organizing the curriculum','Finalizing your course'];
  lsEl.textContent = msgs[0];
  loadingInterval = setInterval(() => { lsEl.textContent = msgs[++i % msgs.length]; }, 1800);

  try {
    const prompt = `You are an expert curriculum designer. Create a structured course as JSON only.

Topic: "${topic}"
${context ? `Additional context: ${context}` : ''}

Return ONLY valid JSON (no markdown fences, no explanation):
{
  "title": "Short course title about ${topic}",
  "tagline": "One sentence describing what students will learn",
  "duration": "X weeks",
  "steps": [
    {
      "id": 1,
      "title": "Module Title",
      "description": "One sentence description of this module",
      "courses": ["Lesson Name 1","Lesson Name 2","Lesson Name 3","Lesson Name 4","Lesson Name 5"]
    }
  ]
}

Create 5-7 modules with 4-6 lessons each. Use specific, concrete lesson names directly about ${topic}. No generic filler names.`;

    const raw = await callGroq([{ role: 'user', content: prompt }], 3000);
    clearInterval(loadingInterval);

    let parsed;
    try {
      const clean = raw.replace(/```json|```/g, '').trim();
      parsed = JSON.parse(clean);
    } catch {
      const match = raw.match(/\{[\s\S]*\}/);
      if (!match) throw new Error('Could not parse course. Please try again.');
      parsed = JSON.parse(match[0]);
    }

    planData = parsed;
    lp.style.display = 'none';
    document.getElementById('appPage').style.display = 'block';
    renderSidebar('plan');
    renderPlanView('course');
    hideAllMainViews();
    document.getElementById('planView').style.display = 'block';
    setNavActive('navCourse');

  } catch (err) {
    clearInterval(loadingInterval);
    lp.innerHTML = `<div style="text-align:center;padding:20px;">
      <p style="color:var(--danger);font-family:'JetBrains Mono',monospace;font-size:13px;margin-bottom:20px;">Error: ${err.message}</p>
      <button class="btn btn-ghost" onclick="location.reload()">‚Üê Start Over</button>
    </div>`;
  }
}

// ‚îÄ‚îÄ WIZARD ‚îÄ‚îÄ
function renderProgress() {
  const track = document.getElementById('progressTrack');
  let html = '';
  QUESTIONS.forEach((q,i) => {
    const state = i < current ? 'done' : i === current ? 'active' : '';
    html += `<div class="prog-step ${state}">
      <div class="prog-bubble">${i < current ? '‚úì' : i+1}</div>
      <div class="prog-label">${STEP_LABELS[i]}</div>
    </div>`;
    if (i < QUESTIONS.length-1) html += `<div class="prog-line ${i<current?'done':''}"></div>`;
  });
  track.innerHTML = html;
}

function renderQuestion() {
  const q = QUESTIONS[current];
  const card = document.getElementById('questionCard');
  const selected = answers[q.id] || '';
  let inner = `<div class="q-number">${q.number}</div><div class="q-title">${q.title}</div>`;

  if (q.type === 'options') {
    inner += `<div class="options-grid">`;
    q.options.forEach(opt => {
      const sel = selected === opt.label ? 'selected' : '';
      inner += `<button class="opt-btn ${sel}" onclick="selectOption('${q.id}','${opt.label}',this)">
        <span class="opt-icon">${opt.icon}</span>
        <span>${opt.label}${opt.desc?`<br/><small style="color:var(--muted);font-weight:400;font-size:11px;">${opt.desc}</small>`:''}</span>
      </button>`;
    });
    inner += `</div>`;
  } else {
    inner += `<textarea class="q-textarea" id="textAnswer" placeholder="${q.placeholder}" oninput="onTextInput(this)">${selected}</textarea>`;
  }

  const isLast = current === QUESTIONS.length - 1;
  inner += `<div class="q-nav">
    ${current > 0 ? `<button class="btn btn-ghost" onclick="goBack()">‚Üê Back</button>` : '<span></span>'}
    ${isLast
      ? `<button class="btn btn-generate" onclick="startGenerate()">üöÄ Generate My Learning Plan</button>`
      : `<button class="btn btn-primary" id="nextBtn" onclick="goNext()" ${q.type==='options'&&!selected?'disabled':''}>Continue ‚Üí</button>`
    }
  </div>`;

  card.innerHTML = inner;
  card.style.animation = 'none'; void card.offsetWidth; card.style.animation = 'fadeUp 0.35s ease';
}

function onTextInput(el) {
  const btn = document.getElementById('nextBtn');
  if (btn) btn.disabled = el.value.trim().length === 0;
}

function selectOption(qId, value, el) {
  answers[qId] = value;
  document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  const btn = document.getElementById('nextBtn');
  if (btn) btn.disabled = false;
}

function goNext() {
  const q = QUESTIONS[current];
  if (q.type === 'textarea') answers[q.id] = document.getElementById('textAnswer').value.trim() || '(not specified)';
  if (!answers[q.id]) return;
  current++;
  renderProgress();
  renderQuestion();
}

function goBack() {
  current--;
  renderProgress();
  renderQuestion();
}

// ‚îÄ‚îÄ GROQ ‚îÄ‚îÄ
async function callGroq(messages, maxTokens = 3000) {
  const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ model: GROQ_MODEL, messages, max_tokens: maxTokens, temperature: 0.7, stream: false })
  });
  if (!res.ok) {
    const e = await res.json().catch(() => ({}));
    throw new Error(e.error?.message || `API Error ${res.status}`);
  }
  return (await res.json()).choices?.[0]?.message?.content || '';
}

// ‚îÄ‚îÄ PLAN GENERATION ‚îÄ‚îÄ
const LOADING_MSGS = ['Analyzing your goals','Designing your learning path','Selecting optimal courses','Organizing your roadmap','Finalizing your plan'];

async function startGenerate(reviseNote = '') {
  const q = QUESTIONS[current];
  if (q && q.type === 'textarea') answers[q.id] = document.getElementById('textAnswer')?.value.trim() || '(not specified)';

  document.getElementById('wizardPage').style.display = 'none';
  document.getElementById('appPage').style.display = 'none';
  const lp = document.getElementById('loadingPage');
  lp.style.display = 'grid';

  let i = 0;
  const lsEl = document.getElementById('loadingStatus');
  lsEl.textContent = LOADING_MSGS[0];
  loadingInterval = setInterval(() => { lsEl.textContent = LOADING_MSGS[++i % LOADING_MSGS.length]; }, 1800);

  try {
    const { goal, field, level, focus, extra } = answers;
    const prompt = `You are an expert curriculum designer. Create a structured learning plan as JSON only.

User inputs:
- Goal: ${goal}
- Field/Role: ${field}
- Level: ${level}
- Focus/Avoid: ${focus}
- Extra context: ${extra}
${reviseNote ? `- Revision request: ${reviseNote}` : ''}

Return ONLY valid JSON (no markdown fences, no explanation):
{
  "title": "Short descriptive plan title",
  "tagline": "One sentence tagline",
  "duration": "X months",
  "steps": [
    {
      "id": 1,
      "title": "Step Title",
      "description": "One sentence description",
      "courses": ["Course Name 1","Course Name 2","Course Name 3","Course Name 4","Course Name 5"]
    }
  ]
}

Create 5-7 steps with 4-6 courses each. Use specific real technology/concept names.`;

    const raw = await callGroq([{ role: 'user', content: prompt }], 3000);
    clearInterval(loadingInterval);

    let parsed;
    try {
      const clean = raw.replace(/```json|```/g, '').trim();
      parsed = JSON.parse(clean);
    } catch {
      const match = raw.match(/\{[\s\S]*\}/);
      if (!match) throw new Error('Could not parse plan. Please try again.');
      parsed = JSON.parse(match[0]);
    }

    planData = parsed;
    activeMode = 'plan';
    lp.style.display = 'none';
    document.getElementById('appPage').style.display = 'block';
    renderSidebar('plan');
    renderPlanView('plan');
    hideAllMainViews();
    document.getElementById('planView').style.display = 'block';
    setNavActive('navPlan');

  } catch (err) {
    clearInterval(loadingInterval);
    lp.innerHTML = `<div style="text-align:center;padding:20px;">
      <p style="color:var(--danger);font-family:'JetBrains Mono',monospace;font-size:13px;margin-bottom:20px;">Error: ${err.message}</p>
      <button class="btn btn-ghost" onclick="location.reload()">‚Üê Start Over</button>
    </div>`;
  }
}

// ‚îÄ‚îÄ RENDER PLAN/COURSE ‚îÄ‚îÄ
function renderSidebar(mode) {
  const el = document.getElementById('sidebarContent');
  const isCourse = activeMode === 'course';
  if (mode === 'plan') {
    const stepLabel = isCourse ? 'Modules' : 'Steps';
    let html = `<div style="padding:8px 12px 4px;"><div class="sidebar-section-label">${stepLabel}</div></div><div class="plan-step-list">`;
    planData.steps.forEach((step,i) => {
      const count = isCourse ? `${step.courses.length} lessons` : `${step.courses.length} courses`;
      html += `<div class="step-nav-item" id="sn${i}" onclick="scrollToStep(${i})">
        <div class="step-nav-num">${i+1}</div>
        <div><div class="step-nav-title">${step.title}</div><div class="step-nav-count">${count}</div></div>
      </div>`;
    });
    html += `</div>`;
    el.innerHTML = html;
  } else {
    const stepBadgePrefix = isCourse ? 'MODULE' : 'STEP';
    let html = '';
    planData.steps.forEach((step,si) => {
      html += `<div class="outline-step-header"><span class="outline-step-badge">${stepBadgePrefix} ${si+1}</span><span class="outline-step-name">${step.title}</span></div>`;
      step.courses.forEach((course,ci) => {
        const active = currentCourse && currentCourse.si===si && currentCourse.ci===ci ? 'active' : '';
        html += `<div class="outline-course-item ${active}" onclick="openCourse(${si},${ci})">
          <div class="outline-num">${ci+1}</div><span>${course}</span>
        </div>`;
      });
    });
    el.innerHTML = html;
  }
}

function renderPlanView(mode) {
  const isCourse = (mode === 'course') || (activeMode === 'course');
  document.getElementById('planBreadcrumb').textContent = isCourse ? 'Course' : 'Learning Plan';
  document.getElementById('revisePlanBtn').textContent = isCourse ? '‚Ü∫ Revise Course' : '‚Ü∫ Revise Plan';
  document.getElementById('planTitle').textContent = planData.title;
  const total = planData.steps.reduce((a,s) => a+s.courses.length, 0);
  const stepLabel = isCourse ? 'modules' : 'steps';
  const itemLabel = isCourse ? 'lessons' : 'courses';
  document.getElementById('planMeta').textContent = `${planData.steps.length} ${stepLabel}, ${total} ${itemLabel}`;

  let html = '';
  planData.steps.forEach((step,si) => {
    const badgeLabel = isCourse ? `MODULE ${si+1}` : `STEP ${si+1}`;
    const countLabel = isCourse ? `${step.courses.length} lessons` : `${step.courses.length} courses`;
    html += `<div class="step-block" id="sb${si}">
      <div class="step-header">
        <div class="step-badge-row">
          <div class="step-badge">${badgeLabel}</div>
          <div class="step-title-text">${step.title}</div>
        </div>
        <div class="step-course-count">${countLabel}</div>
      </div>
      ${step.description ? `<p style="font-size:13px;color:var(--muted);margin:-4px 0 14px;">${step.description}</p>` : ''}
      <div class="course-list">`;
    step.courses.forEach((course,ci) => {
      html += `<div class="course-row" onclick="openCourse(${si},${ci})">
        <div class="course-num">${ci+1}</div>
        <div class="course-name">${course}</div>
        <div class="course-arrow">‚Üó</div>
      </div>`;
    });
    html += `</div></div>`;
  });
  document.getElementById('stepsContainer').innerHTML = html;
}

function showPlanView() {
  hideAllMainViews();
  document.getElementById('planView').style.display = 'block';
  setNavActive(activeMode === 'course' ? 'navCourse' : 'navPlan');
  renderSidebar('plan');
}

function scrollToStep(i) {
  document.getElementById(`sb${i}`)?.scrollIntoView({ behavior:'smooth', block:'start' });
  document.querySelectorAll('.step-nav-item').forEach(e => e.classList.remove('active'));
  document.getElementById(`sn${i}`)?.classList.add('active');
}

// ‚îÄ‚îÄ LESSON ‚îÄ‚îÄ
async function openCourse(si, ci) {
  const step = planData.steps[si];
  const courseName = step.courses[ci];
  currentCourse = { si, ci, name: courseName, stepTitle: step.title, stepNum: si+1 };
  instructorHistory = [];

  hideAllMainViews();
  document.getElementById('lessonView').style.display = 'block';
  setNavActive('');
  renderSidebar('lesson');

  document.getElementById('lessonTitle').textContent = courseName;
  document.getElementById('lessonMeta').textContent = `Step ${si+1}: ${step.title}`;
  document.getElementById('lessonProgressFill').style.width = '0%';
  document.getElementById('lessonBody').innerHTML = `<div class="lesson-loading"><div class="lesson-spinner"></div>Generating lesson content<span class="loading-dots"></span></div>`;
  document.getElementById('instructorMessages').innerHTML = '';
  document.getElementById('suggestedQs').innerHTML = '';

  try {
    const content = await generateLesson(courseName, step.title, si+1);
    document.getElementById('lessonBody').innerHTML = content;
    document.getElementById('lessonProgressFill').style.width = '25%';
    await initInstructor(courseName, step.title);
  } catch(err) {
    document.getElementById('lessonBody').innerHTML = `<p style="color:var(--danger)">Error: ${err.message}</p>`;
  }
}

async function generateLesson(courseName, stepTitle, stepNum) {
  const isCourse = activeMode === 'course';
  const learnerContext = isCourse
    ? `Topic: ${planData?.title}, Module ${stepNum}: ${stepTitle}`
    : `Learner: ${answers.field}, level: ${answers.level}`;

  const prompt = `Write lesson content for: "${courseName}" (${isCourse ? 'Module' : 'Step'} ${stepNum}: ${stepTitle})
${learnerContext}

Return clean HTML content elements only (no DOCTYPE, no html/body tags).
Structure:
- 2-3 intro paragraphs
- 3-4 sections with <h2> headings
- Each section: 2-3 paragraphs
- 1-2 code examples in <pre><code> where relevant
- End with <h2>Key Takeaways</h2> and a <ul>

Use <h2>, <h3>, <p>, <ul>, <li>, <pre><code>, <strong>, <code> tags only. Be practical and specific.`;

  return callGroq([{role:'user',content:prompt}], 2000);
}

async function initInstructor(courseName, stepTitle) {
  addMsg('ai', `Hello! I'm your AI Instructor for <strong>${courseName}</strong>. Ask me anything about this lesson ‚Äî concepts, examples, or how to apply this in practice.`);

  try {
    const sqRaw = await callGroq([{role:'user',content:`Generate 4 short questions a learner might ask about "${courseName}". Return JSON array only: ["Q1","Q2","Q3","Q4"]`}], 300);
    const match = sqRaw.match(/\[[\s\S]*?\]/);
    const qs = match ? JSON.parse(match[0]) : [];
    renderSuggestedQs(qs.length ? qs : defaultQs(courseName));
  } catch {
    renderSuggestedQs(defaultQs(courseName));
  }
}

function defaultQs(name) {
  return [`What are the key concepts in ${name}?`,'Can you give a practical example?','What are common mistakes to avoid?','How does this apply in real projects?'];
}

function renderSuggestedQs(qs) {
  const el = document.getElementById('suggestedQs');
  let html = `<div class="suggested-label">Suggested questions</div>`;
  qs.forEach(q => {
    html += `<button class="sugg-q" onclick="askSuggested(this,'${q.replace(/'/g,"\\'").replace(/"/g,'\\"')}')">${q}</button>`;
  });
  el.innerHTML = html;
}

function askSuggested(btn, q) {
  btn.disabled = true; btn.style.opacity = '0.4';
  document.getElementById('instructorInput').value = q;
  sendInstructorMessage();
}

function addMsg(role, html) {
  const msgs = document.getElementById('instructorMessages');
  const div = document.createElement('div');
  div.className = `msg msg-${role}`;
  div.innerHTML = `<div class="msg-avatar">${role==='ai'?'ü§ñ':'üë§'}</div><div class="msg-bubble">${html}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function addTyping() {
  const msgs = document.getElementById('instructorMessages');
  const div = document.createElement('div');
  div.id = 'typing'; div.className = 'msg msg-ai typing-indicator';
  div.innerHTML = `<div class="msg-avatar">ü§ñ</div><div class="msg-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  msgs.appendChild(div); msgs.scrollTop = msgs.scrollHeight;
}

function removeTyping() { document.getElementById('typing')?.remove(); }

async function sendInstructorMessage() {
  const input = document.getElementById('instructorInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = ''; autoResize(input);
  document.getElementById('sendBtn').disabled = true;
  addMsg('user', text);
  addTyping();
  instructorHistory.push({role:'user',content:text});

  try {
    const reply = await callGroq([
      {role:'system',content:`You are an AI Instructor for "${currentCourse?.name}". ${activeMode === 'course' ? `Course: ${planData?.title}` : `Learner field: ${answers.field}, level: ${answers.level}`}. Be helpful, concise (under 120 words unless example needed). Use **bold** for key terms.`},
      ...instructorHistory
    ], 500);
    removeTyping();
    instructorHistory.push({role:'assistant',content:reply});
    addMsg('ai', reply.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'));
  } catch(err) {
    removeTyping();
    addMsg('ai', `Sorry, error: ${err.message}`);
  }
  document.getElementById('sendBtn').disabled = false;
}

function handleInstructorKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendInstructorMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 90) + 'px';
}

function openRevise() {
  const titles = { plan: '‚úèÔ∏è Revise Plan', course: '‚úèÔ∏è Revise Course', guide: '‚úèÔ∏è Revise Guide', roadmap: '‚úèÔ∏è Revise Roadmap' };
  document.getElementById('reviseModal').querySelector('h3').textContent = titles[activeMode] || '‚úèÔ∏è Revise';
  document.getElementById('reviseModal').classList.add('open');
  document.getElementById('reviseInput').focus();
}
function closeRevise() { document.getElementById('reviseModal').classList.remove('open'); }
async function applyRevise() {
  const note = document.getElementById('reviseInput').value.trim();
  if (!note) return;
  document.getElementById('reviseInput').value = '';
  closeRevise();
  if (activeMode === 'course') {
    await runCourseGeneration(planData?.title || 'the same topic', `Revision: ${note}`);
  } else if (activeMode === 'guide') {
    const prefs = { ...guideData?.prefs, revision: note };
    await runGuideGeneration(guideData?.topic || 'the same topic', prefs);
  } else if (activeMode === 'roadmap') {
    await runRoadmapGeneration(roadmapData?.topic || 'the same topic', `Revision: ${note}`);
  } else {
    await startGenerate(note);
  }
}
document.getElementById('reviseModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeRevise(); });

function startOver() {
  current = 0; answers = {}; planData = null; currentCourse = null;
  instructorHistory = []; guideData = null; guideHistory = {};
  guidePrefs = {}; appGuidePrefs = {};
  roadmapData = null; roadmapHistory = []; selectedRoadmapNodeData = null;
  selectedWizardFormat = 'course'; selectedAppFormat = 'course';
  activeMode = 'plan';
  document.getElementById('appPage').style.display = 'none';
  document.getElementById('loadingPage').style.display = 'none';
  document.getElementById('wizardPage').style.display = 'flex';
  // Reset guide creator fields
  document.getElementById('guideTopicInput').value = '';
  document.getElementById('guideGenBtn').disabled = true;
  document.getElementById('guidePersonalization').style.display = 'block';
  // Reset course creator fields
  document.getElementById('courseTopicInput').value = '';
  document.getElementById('courseGenBtn').disabled = true;
  document.getElementById('contextCheckbox').checked = false;
  document.getElementById('courseContextArea').style.display = 'none';
  // Reset roadmap creator fields
  document.getElementById('roadmapTopicInput').value = '';
  document.getElementById('roadmapWizardGenBtn').disabled = true;
  // Reset chips
  document.querySelectorAll('.chip.selected').forEach(c => c.classList.remove('selected'));
  switchWizardMode('plan');
  window.scrollTo({top:0});
  renderProgress(); renderQuestion();
}

// ‚îÄ‚îÄ QUIZ STATE ‚îÄ‚îÄ
let quizData = null;
let quizCurrent = 0;
let quizAnswers = []; // { selected, correct, isCorrect }
let quizLocked = false;

// ‚îÄ‚îÄ QUIZ WIZARD/APP HELPERS ‚îÄ‚îÄ
function updateQuizWizardBtn() {
  document.getElementById('quizWizardGenBtn').disabled = !document.getElementById('quizTopicInput').value.trim();
}
function toggleQuizWizardContext() {
  const cb = document.getElementById('quizWizardContextCheckbox');
  cb.checked = !cb.checked;
  document.getElementById('quizWizardContextArea').style.display = cb.checked ? 'block' : 'none';
}
function updateAppQuizGenBtn() {
  document.getElementById('appQuizGenBtn').disabled = !document.getElementById('appQuizTopicInput').value.trim();
}
function toggleAppQuizContext() {
  const cb = document.getElementById('appQuizContextCheckbox');
  cb.checked = !cb.checked;
  document.getElementById('appQuizContextArea').style.display = cb.checked ? 'block' : 'none';
}

function showQuizCreatorApp() {
  hideAllMainViews();
  document.getElementById('quizCreatorApp').style.display = 'block';
  setNavActive('navQuiz');
  document.getElementById('sidebarContent').innerHTML = '';
  document.getElementById('appQuizTopicInput').value = '';
  document.getElementById('appQuizGenBtn').disabled = true;
  document.getElementById('appQuizContextCheckbox').checked = false;
  document.getElementById('appQuizContextArea').style.display = 'none';
}

async function startWizardQuizGenerate() {
  const topic = document.getElementById('quizTopicInput').value.trim();
  if (!topic) return;
  const context = document.getElementById('quizWizardContextCheckbox').checked
    ? document.getElementById('quizWizardContextInput').value.trim() : '';
  await runQuizGeneration(topic, context);
}

async function startAppQuizGenerate() {
  const topic = document.getElementById('appQuizTopicInput').value.trim();
  if (!topic) return;
  const context = document.getElementById('appQuizContextCheckbox').checked
    ? document.getElementById('appQuizContextInput').value.trim() : '';
  await runQuizGeneration(topic, context);
}

// ‚îÄ‚îÄ QUIZ GENERATION ‚îÄ‚îÄ
async function runQuizGeneration(topic, context = '') {
  activeMode = 'quiz';
  document.getElementById('wizardPage').style.display = 'none';
  document.getElementById('appPage').style.display = 'none';
  const lp = document.getElementById('loadingPage');
  lp.style.display = 'grid';
  lp.querySelector('.loading-title').innerHTML = 'Generating your quiz<span class="loading-dots"></span>';

  let i = 0;
  const lsEl = document.getElementById('loadingStatus');
  const msgs = ['Analyzing the topic', 'Writing questions', 'Adding tricky distractors', 'Crafting explanations', 'Finalizing your quiz'];
  lsEl.textContent = msgs[0];
  loadingInterval = setInterval(() => { lsEl.textContent = msgs[++i % msgs.length]; }, 1600);

  try {
    const prompt = `You are a quiz creator. Generate a 10-question multiple-choice quiz about "${topic}".
${context ? `Additional context: ${context}` : ''}

Return ONLY valid JSON (no markdown, no fences):
{
  "title": "Short quiz title about ${topic}",
  "topic": "${topic}",
  "questions": [
    {
      "question": "Question text?",
      "options": ["Option A", "Option B", "Option C", "Option D"],
      "correct": 0,
      "explanation": "Brief 1-2 sentence explanation of why the correct answer is right."
    }
  ]
}

Rules:
- "correct" is the 0-based index of the correct option in the "options" array
- All 4 options should be plausible (good distractors)
- Range from easy to hard, covering different aspects of "${topic}"
- Explanations should be educational and clear (max 40 words)
- Questions should be clear and unambiguous`;

    const raw = await callGroq([{ role: 'user', content: prompt }], 3500);
    clearInterval(loadingInterval);

    let parsed;
    try {
      const clean = raw.replace(/```json|```/g, '').trim();
      parsed = JSON.parse(clean);
    } catch {
      const match = raw.match(/\{[\s\S]*\}/);
      if (!match) throw new Error('Could not parse quiz. Please try again.');
      parsed = JSON.parse(match[0]);
    }

    quizData = parsed;
    quizCurrent = 0;
    quizAnswers = [];
    quizLocked = false;

    lp.style.display = 'none';
    document.getElementById('appPage').style.display = 'block';
    renderQuizSidebar();
    hideAllMainViews();
    document.getElementById('quizView').style.display = 'block';
    setNavActive('navQuiz');
    renderQuizTitle();
    renderQuizQuestion();

  } catch (err) {
    clearInterval(loadingInterval);
    lp.innerHTML = `<div style="text-align:center;padding:20px;">
      <p style="color:var(--danger);font-family:'JetBrains Mono',monospace;font-size:13px;margin-bottom:20px;">Error: ${err.message}</p>
      <button class="btn btn-ghost" onclick="location.reload()">‚Üê Start Over</button>
    </div>`;
  }
}

function renderQuizSidebar() {
  const el = document.getElementById('sidebarContent');
  let html = `<div style="padding:8px 12px 4px;"><div class="sidebar-section-label">Questions</div></div>
  <div class="guide-section-nav">`;
  quizData.questions.forEach((q, i) => {
    html += `<div class="guide-nav-item" id="qsnav-${i}" onclick="jumpToQuizQ(${i})">
      <div class="guide-nav-dot"></div>
      <div class="guide-nav-label">Q${i + 1}: ${q.question.length > 38 ? q.question.slice(0, 38) + '‚Ä¶' : q.question}</div>
    </div>`;
  });
  html += `</div>`;
  el.innerHTML = html;
}

function renderQuizTitle() {
  document.getElementById('quizTitle').textContent = quizData.title;
}

function updateQuizProgress() {
  const total = quizData.questions.length;
  const answered = quizAnswers.length;
  const pct = Math.round((answered / total) * 100);
  document.getElementById('quizProgressFill').style.width = pct + '%';
  document.getElementById('quizProgressLabel').textContent = `${quizCurrent + 1} / ${total}`;
  // Sidebar highlight
  document.querySelectorAll('[id^="qsnav-"]').forEach((el, i) => {
    el.classList.toggle('active', i === quizCurrent);
    // color answered items
    if (i < quizAnswers.length) {
      el.querySelector('.guide-nav-dot').style.background = quizAnswers[i].isCorrect ? 'var(--accent2)' : 'var(--danger)';
    }
  });
}

function renderQuizQuestion() {
  const q = quizData.questions[quizCurrent];
  const area = document.getElementById('quizQuestionArea');
  const total = quizData.questions.length;
  const isLast = quizCurrent === total - 1;
  const alreadyAnswered = quizCurrent < quizAnswers.length;
  const ans = alreadyAnswered ? quizAnswers[quizCurrent] : null;

  let optHtml = '';
  q.options.forEach((opt, oi) => {
    let cls = '';
    if (alreadyAnswered) {
      if (oi === q.correct) cls = 'correct';
      else if (oi === ans.selected && !ans.isCorrect) cls = 'wrong';
      else cls = 'locked';
    }
    optHtml += `<div class="quiz-option ${cls} ${alreadyAnswered ? 'locked' : ''}" onclick="${alreadyAnswered ? '' : `pickQuizOption(${oi})`}">
      <div class="quiz-option-letter">${['A','B','C','D'][oi]}</div>
      <div class="quiz-option-text">${opt}</div>
    </div>`;
  });

  let feedbackHtml = '';
  if (alreadyAnswered) {
    const fc = ans.isCorrect ? 'correct' : 'wrong';
    const icon = ans.isCorrect ? '‚úì Correct!' : '‚úó Incorrect';
    feedbackHtml = `<div class="quiz-feedback-bar ${fc}" style="display:block;">
      <div class="quiz-feedback-label">${icon}</div>
      ${!ans.isCorrect ? `<div>Correct answer: <strong>${q.options[q.correct]}</strong></div>` : ''}
      <div style="margin-top:4px;color:var(--muted)">${q.explanation}</div>
    </div>`;
  }

  let navHtml = `<div class="quiz-nav">
    ${quizCurrent > 0 ? `<button class="quiz-nav-btn quiz-nav-btn-ghost" onclick="quizGoBack()">‚Üê Back</button>` : ''}
    ${alreadyAnswered
      ? (isLast
          ? `<button class="quiz-nav-btn quiz-nav-btn-primary" onclick="showQuizResults()">See Results ‚Üí</button>`
          : `<button class="quiz-nav-btn quiz-nav-btn-primary" onclick="quizGoNext()">Next Question ‚Üí</button>`)
      : `<button class="quiz-nav-btn quiz-nav-btn-primary" id="quizNextBtn" disabled onclick="confirmQuizAnswer()">Confirm Answer</button>`
    }
  </div>`;

  area.innerHTML = `
    <div class="quiz-q-card">
      <div class="quiz-q-num">Question ${quizCurrent + 1} of ${total}</div>
      <div class="quiz-q-text">${q.question}</div>
      <div class="quiz-options" id="quizOptions">${optHtml}</div>
    </div>
    ${feedbackHtml}
    ${navHtml}`;

  updateQuizProgress();
  document.getElementById('quizResultsArea').style.display = 'none';
  area.style.display = 'block';
}

function pickQuizOption(oi) {
  // Clear previous selection
  document.querySelectorAll('.quiz-option').forEach(el => el.classList.remove('selected'));
  document.querySelectorAll('.quiz-option')[oi].classList.add('selected');
  document.getElementById('quizNextBtn').disabled = false;
  document.getElementById('quizNextBtn').dataset.selected = oi;
}

function confirmQuizAnswer() {
  const btn = document.getElementById('quizNextBtn');
  const selected = parseInt(btn.dataset.selected);
  const q = quizData.questions[quizCurrent];
  const isCorrect = selected === q.correct;
  quizAnswers[quizCurrent] = { selected, correct: q.correct, isCorrect };
  renderQuizQuestion();
}

function quizGoNext() {
  if (quizCurrent < quizData.questions.length - 1) {
    quizCurrent++;
    renderQuizQuestion();
  }
}

function quizGoBack() {
  if (quizCurrent > 0) {
    quizCurrent--;
    renderQuizQuestion();
  }
}

function jumpToQuizQ(i) {
  // Only allow jumping to answered questions or the next unanswered one
  if (i <= quizAnswers.length) {
    quizCurrent = i;
    renderQuizQuestion();
  }
}

function showQuizResults() {
  const total = quizData.questions.length;
  const correct = quizAnswers.filter(a => a.isCorrect).length;
  const wrong = total - correct;
  const pct = Math.round((correct / total) * 100);

  let ringCls = pct >= 70 ? 'great' : pct >= 40 ? 'ok' : 'low';
  let msg = pct >= 80 ? 'Excellent work! üéâ' : pct >= 60 ? 'Good job! Keep it up üëç' : pct >= 40 ? 'Room for improvement üìö' : 'Keep studying! üí™';
  let sub = pct >= 80 ? 'You have a strong grasp of this topic.'
    : pct >= 60 ? 'You know the basics ‚Äî review the missed questions.'
    : pct >= 40 ? 'Review the explanations and try again.'
    : 'Go back and study the topic, then retry.';

  let reviewHtml = '';
  quizData.questions.forEach((q, i) => {
    const ans = quizAnswers[i];
    if (!ans) return;
    const cls = ans.isCorrect ? 'ri-correct' : 'ri-wrong';
    const icon = ans.isCorrect ? '‚úì' : '‚úó';
    reviewHtml += `<div class="quiz-review-item ${cls}">
      <div class="quiz-review-q">${icon} Q${i+1}: ${q.question}</div>
      <div class="quiz-review-ans">Your answer: ${q.options[ans.selected]}</div>
      ${!ans.isCorrect ? `<div class="quiz-review-correct">Correct: ${q.options[q.correct]}</div>` : ''}
    </div>`;
  });

  document.getElementById('quizQuestionArea').style.display = 'none';
  document.getElementById('quizProgressLabel').textContent = `${total} / ${total}`;
  document.getElementById('quizProgressFill').style.width = '100%';

  document.getElementById('quizResultsArea').style.display = 'block';
  document.getElementById('quizResultsArea').innerHTML = `
    <div class="quiz-results">
      <div class="quiz-score-ring ${ringCls}">${pct}%</div>
      <div class="quiz-results-title">${msg}</div>
      <div class="quiz-results-sub">${sub}</div>
      <div class="quiz-stat-row">
        <div class="quiz-stat"><div class="quiz-stat-val score">${pct}%</div><div class="quiz-stat-lbl">Score</div></div>
        <div class="quiz-stat"><div class="quiz-stat-val correct">${correct}</div><div class="quiz-stat-lbl">Correct</div></div>
        <div class="quiz-stat"><div class="quiz-stat-val wrong">${wrong}</div><div class="quiz-stat-lbl">Wrong</div></div>
        <div class="quiz-stat"><div class="quiz-stat-val" style="color:var(--muted)">${total}</div><div class="quiz-stat-lbl">Total</div></div>
      </div>
      <div class="quiz-result-actions">
        <button class="action-btn action-btn-ghost" onclick="retakeQuiz()">‚Ü∫ Retake Quiz</button>
        <button class="action-btn action-btn-ghost" onclick="showQuizCreatorApp()">Ôºã New Quiz</button>
      </div>
      <div class="quiz-review-list">
        <div class="quiz-review-label">Question Review</div>
        ${reviewHtml}
      </div>
    </div>`;
}

function retakeQuiz() {
  quizCurrent = 0;
  quizAnswers = [];
  quizLocked = false;
  document.getElementById('quizResultsArea').style.display = 'none';
  document.getElementById('quizQuestionArea').style.display = 'block';
  renderQuizQuestion();
}

// ‚îÄ‚îÄ PATCH: extend hideAllMainViews, setNavActive, switchWizardMode, startOver for quiz ‚îÄ‚îÄ
const _origHideAll = hideAllMainViews;
hideAllMainViews = function() {
  _origHideAll();
  const qv = document.getElementById('quizView');
  const qca = document.getElementById('quizCreatorApp');
  if (qv) qv.style.display = 'none';
  if (qca) qca.style.display = 'none';
};

const _origSetNav = setNavActive;
setNavActive = function(activeId) {
  _origSetNav(activeId);
  const nq = document.getElementById('navQuiz');
  if (nq) nq.classList.toggle('active', activeId === 'navQuiz');
};

const _origSwitchMode = switchWizardMode;
switchWizardMode = function(mode) {
  _origSwitchMode(mode);
  const qw = document.getElementById('quizCreatorWizard');
  const tq = document.getElementById('tabQuiz');
  if (qw) qw.style.display = mode === 'quiz' ? 'block' : 'none';
  if (tq) tq.classList.toggle('active', mode === 'quiz');
  if (mode === 'quiz') {
    document.getElementById('wizardTitle').innerHTML = 'AI Quiz<br/>Generator';
    document.getElementById('wizardSubtitle').textContent = 'Type a topic ‚Üí get a personalized quiz';
  }
};

// Init
renderProgress();
renderQuestion();

</script>
</body>
</html>
